<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Creating A Deploy Script For Jekyll With Rsync | Fan Pu Zeng </title> <meta name="author" content="Fan Pu Zeng"> <meta name="description" content="Static site generators like Jekyll makes it easy to write and build static websites. However, this still comes with the problem of a suitable deployment method. I will share about my thought process and the best approach I found for tackling this problem. "> <meta name="keywords" content="fanpu, fan pu, fanpu zeng, fan pu zeng, zengfanpu, fanpuzeng, fzeng, CMU, cmu, carnegie mellon, cmu courses, school of computer science, scs, machine learning, computer science, ml, theory, courses, course reviews, CS, Jane Street"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/favicon_new.ico?426605099301e95aedae716cc398b951"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fanpu.github.io/blog/2018/creating-a-deploy-script-for-jekyll-with-rsync/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fan Pu</span> Zeng </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/courses/">CMU Course Reviews </a> </li> <li class="nav-item "> <a class="nav-link" href="/cmu-online/">CMU Online </a> </li> <li class="nav-item "> <a class="nav-link" href="/summaries/">ML Paper Summaries </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Creating A Deploy Script For Jekyll With Rsync</h1> <p class="post-meta"> Created in June 25, 2018 by fanpu </p> <p class="post-tags"> <a href="/blog/2018"> <i class="fa-solid fa-calendar fa-sm"></i> 2018 </a>   ·   <a href="/blog/tag/code"> <i class="fa-solid fa-hashtag fa-sm"></i> code</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Static site generators like <a href="https://jekyllrb.com" rel="external nofollow noopener" target="_blank">Jekyll</a> makes it easy to write and build static websites. However, this still comes with the problem of a suitable deployment method. I will share about my thought process and the best approach I found for tackling this problem.</p> <h3 id="initial-idea-build-docker-image-on-successful-circleci-build-and-deploy">Initial Idea: Build Docker image on successful CircleCI build and deploy</h3> <blockquote> <p>Simplicity: 1/5</p> <p>Ease of use: 5/5</p> <p>Maintainability: 2/5</p> </blockquote> <p>Having read a bit on DevOps best practices for continuous deployment, my first idea was to add <a href="https://circleci.com/" rel="external nofollow noopener" target="_blank">CircleCI</a> integration to Github (where the code for this <a href="https://github.com/fanpu/blog" rel="external nofollow noopener" target="_blank">blog</a> is hosted), and configure it to build the site into a Docker image when it passes a series of sanity checks (since there is almost no point running/writing tests for a static site). There will be a post-build hook for the server hosting my blog to fetch the latest image for my blog and to serve that latest build. Of course, using Docker also means that I will have to dig into NGINX and <code class="language-plaintext highlighter-rouge">proxy_pass</code> the requests to the container. I will also need to configure the container to autorestart in the event the server goes down.</p> <p>To anyone this probably seems like overkill and rightly so. I was bringing production DevOps concepts (i.e continuous deployment, immutable deploys, zero-downtime) onto the table without any strong justifications. To further complicate things I found out that CircleCI just updated to 2.0, which has very different syntax from 1.0, meaning that most guides are obsolete. Having so many moving parts also increases the chances of failure, making it a hassle to maintain. The only pros to this approach is that if setup correctly, deploying will be as simple as pushing my code. Given the overwhelming cons however I decided not to explore this approach any further.</p> <h3 id="second-possible-approach-create-a-bare-git-repository-on-the-server-and-building-with-git-hooks">Second Possible Approach: Create a Bare Git Repository on the Server and Building with Git Hooks</h3> <blockquote> <p>Simplicity: 3/5</p> <p>Ease of use: 4/5</p> <p>Maintainability: 3/5</p> </blockquote> <p>The second approach is largely inspired by <a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-a-jekyll-site-using-git-hooks-on-ubuntu-16-04" rel="external nofollow noopener" target="_blank">this post</a> and it centers on using Git hooks to build and deploy. You first create a bare Git repository (a bare Git repository is one used by a server machine to host the code and contains no working tree, more information <a href="http://www.saintsjd.com/2011/01/what-is-a-bare-git-repository/" rel="external nofollow noopener" target="_blank">here</a>) on the server, and create a <strong>git</strong> user and an ssh key pair for that user. Then, create a post-receive hook in the <code class="language-plaintext highlighter-rouge">hooks</code> directory with the following contents:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">GIT_REPO</span><span class="o">=</span><span class="nv">$HOME</span>/blog.git
<span class="nv">TMP_GIT_CLONE</span><span class="o">=</span>/tmp/blog
<span class="nv">PUBLIC_WWW</span><span class="o">=</span>/var/www/html <span class="c"># depending on your distribution or server config this will differ</span>

git clone <span class="nv">$GIT_REPO</span> <span class="nv">$TMP_GIT_CLONE</span>
<span class="nb">pushd</span> <span class="nv">$TMP_GIT_CLONE</span>
bundle <span class="nb">exec </span>jekyll build <span class="nt">-d</span> <span class="nv">$PUBLIC_WWW</span>
<span class="nb">popd
rm</span> <span class="nt">-rf</span> <span class="nv">$TMP_GIT_CLONE</span>

<span class="nb">exit</span></code></pre></figure> <p>The script clones the repository to the <code class="language-plaintext highlighter-rouge">/tmp</code> directory, and then builds the site at the directory where it is served. The temporary directory is then deleted. <code class="language-plaintext highlighter-rouge">pushd</code> functions similarly to <code class="language-plaintext highlighter-rouge">cd</code> by pushing to the command line directory stack, and <code class="language-plaintext highlighter-rouge">popd</code> pops from this stack and returns to the directory at the top of the stack.</p> <p>An interesting concept that I learned from the post is on the creation of non-interactive shells, which seemed quite smart to me. Basically, you create a shell script that prints a helpful message that the ssh attempt was successful, and then exit.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="c"># in ~/git-shell-commands/no-interactive-login</span>
<span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"You've successfully authenticated to the server as </span><span class="nv">$USER</span><span class="s2"> user, but interactive sessions are disabled."</span>

<span class="nb">exit </span>128</code></pre></figure> <p>Exit code 128 means <a href="http://tldp.org/LDP/abs/html/exitcodes.html" rel="external nofollow noopener" target="_blank">“Invalid argument to exit”</a>. Make the script executable, and update the shell for the <strong>git</strong> user as follows.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>usermod <span class="nt">-s</span> <span class="si">$(</span>which git-shell<span class="si">)</span> git</code></pre></figure> <p>Attempting to ssh as the <strong>git</strong> user will now cause the login shell to execute and immediately terminate.</p> <figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="go">Welcome to Ubuntu 16.04.3 LTS (GNU/Linux 4.4.0-109-generic x86_64)
</span><span class="c">...
</span><span class="go">You've successfully authenticated to the server as git user, but interactive sessions are disabled.
Connection to production_server_ip closed.</span></code></pre></figure> <p>While feasible and definitely not difficult to set up, my main jibe with this deployment method is the need to host my code on Git repository on the server. I would very much rather have it hosted and open sourced on GitHub and be able to leverage its many powerful capabilities. Furthermore, in the event that I ever lose access to the server (i.e lost my private key or failed to pay my server bills) and lose my local copy of the files the results are catastrophic. I also did not like how this method of deployment basically ties me to the server and increases friction significantly should I want to deploy elsewhere on a new machine instead.</p> <p>As a result, I give it 3 in terms of simplicity due to some set up required, 4 for ease of use since it removes my ability to use GitHub’s powerful browsing features, and 3 for maintainability since it is easy for me to lose the files and there is a lot of overhead in switching to other servers. These factors are enough to convince me to find an alternative method.</p> <h3 id="the-chosen-method-deploying-with-rsync">The Chosen Method: Deploying with rsync</h3> <blockquote> <p>Simplicity: 5/5</p> <p>Ease of use: 4/5</p> <p>Maintainability: 5/5</p> </blockquote> <p>A bit of a backstory: after editing our internal <a href="https://github.com/lord/slate" rel="external nofollow noopener" target="_blank">Slate</a> API documentation in <a href="https://www.saleswhale.com" rel="external nofollow noopener" target="_blank">Saleswhale</a> after I updated the API, I was trying to find out how to deploy the changes. Our Rails and Ember apps are deployed using <a href="https://github.com/fabric/fabric" rel="external nofollow noopener" target="_blank">Fabric</a>, and naturally I was looking for something similar. I found a <code class="language-plaintext highlighter-rouge">deploy.sh</code> script that only contained two lines. I told my senior colleague who wrote it that I am in disbelief that this is all it took, and he laughed and told me that yes it works, now you go try it. The first line was to build the project, and the second line is to <strong>rysnc</strong> the contents to the server. I hope that I will be able to share this magical feeling of disbelief with you after you see how simple it can get.</p> <p>This section takes a lot of reference from the official <a href="https://jekyllrb.com/docs/deployment-methods/#rsync" rel="external nofollow noopener" target="_blank">Jekyll docs</a> so you can take a look if you want to dive in deeper. First, install <strong>rrsync</strong> on the server. <strong>rrsync</strong> (restricted rsync) offers some benefits on top of <em>rsync</em> by restricting the directories that <em>rsync</em> can access. Create a new keypair for <em>rsync</em> on your client at <code class="language-plaintext highlighter-rouge">~/.ssh/jekyll_rsync_id_rsa</code>, and add the following contents to <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code> on the server.</p> <figure class="highlight"><pre><code class="language-terminal" data-lang="terminal"><span class="gp">command="$</span>HOME/bin/rrsync &lt;folder&gt;<span class="s2">",no-agent-forwarding,no-port-forwarding,no-pty,no-user-rc,no-X11-forwarding ssh-rsa &lt;cert&gt;</span></code></pre></figure> <p>For me, I replaced <code class="language-plaintext highlighter-rouge">&lt;folder&gt;</code> with <code class="language-plaintext highlighter-rouge">/usr/share/nginx/blog</code> and <code class="language-plaintext highlighter-rouge">&lt;cert&gt;</code> is public key for your newly generated keypair. <strong>rsync</strong> will only be able to access and modify contents within the specified folder.</p> <p>On the client, append a new entry for your newly created key to your <code class="language-plaintext highlighter-rouge">.ssh/config</code>:</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Jekyll rsync</span>
Host jekyll-rsync
  HostName &lt;server <span class="nb">hostname </span>or ip&gt;
  User &lt;user&gt;
  IdentityFile ~/.ssh/jekyll_rsync_id_rsa</code></pre></figure> <p>Change the values as appropriate for your configuration. Then, create a script <code class="language-plaintext highlighter-rouge">deploy</code> in your project directory.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/sh</span>
<span class="nv">JEKYLL_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>jekyll build
rsync <span class="nt">-crvz</span> <span class="nt">--rsh</span><span class="o">=</span><span class="s1">'ssh -p22'</span> <span class="nt">--delete-after</span> <span class="nt">--delete-excluded</span>  _site/ jekyll-rsync:</code></pre></figure> <p>Lastly, you can exclude the deploy script from being included in the output folder by adding the following to the <code class="language-plaintext highlighter-rouge">_config.yml</code> file:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Do not copy these files to the output directory</span>
<span class="ss">exclude: </span><span class="p">[</span><span class="s2">"deploy"</span><span class="p">]</span></code></pre></figure> <p>Set deploy as executable with <code class="language-plaintext highlighter-rouge">chmod +x deploy</code>, and run <code class="language-plaintext highlighter-rouge">./deploy</code>. You will see your newly built site on production in no time!</p> <p>I personally like this method very much due to its ease of setup and extensibility, and give it a 5 for simplicity without recommendations. I would downgrade its ease of use slightly to 4 simply because I have to run the deploy script separately from pushing the code, however this can be easily solved via a post-commit hook. I did not opt for this however as I would rather not have to wait a while for it to build and copy each commit as I tend to commit multiple times at once. Maintainability gets a 5 as there is no tight coupling between the client and server, and the setup is easy enough to make any transfer friction negligible. This method of deployment is in fact what I am currently using and I am very happy with it.</p> <p>Using <strong>rsync</strong> for deploying static sites keeps things simple and taking advantage of the 80/20 rule. Let me know in the comments what are your thoughts, and if there are other deployment methods that you would use and recommend. Thanks for reading!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <p class="mb-2">Related Posts:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/llama-3.1-technical-report-notes/">Notes on 'The Llama 3 Herd of Models'</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/setting-up-yuancon-controller-sound-voltex/">Playing Sound Voltex at Home: Setting Up Unnamed SDVX Clone with the Yuancon SDVX Controller</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/creating-trackback-requests/">Creating Trackback Requests for Static Sites</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/high-dimensional-analysis-of-m-estimators/">A Unified Framework for High-Dimensional Analysis of M-Estimators with Decomposable Regularizers: A Guided Walkthrough</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cmu-steam-tunnels/">The CMU Steam Tunnels and Wean 9</a> </li> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>
      let giscusTheme = determineComputedTheme();
      let giscusAttributes = {
        src: 'https://giscus.app/client.js',
        'data-repo': 'fanpu/fanpu.github.io',
        'data-repo-id': '',
        'data-category': 'Comments',
        'data-category-id': '',
        'data-mapping': 'title',
        'data-strict': '1',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'bottom',
        'data-theme': giscusTheme,
        'data-lang': 'en',
        crossorigin: 'anonymous',
        async: '',
      };

      let giscusScript = document.createElement('script');
      Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
      document.getElementById('giscus_thread').appendChild(giscusScript);
    </script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Fan Pu Zeng. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: January 01, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script src="/assets/js/tooltips-setup.js?53023e960fbc64cccb90d32e9363de2b"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S3VHEYH05S"></script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>