<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Breaking CMU's Bomblab with Angr for Fun and Profit - Part 1 | Fan Pu  Zeng</title>
    <meta name="author" content="Fan Pu  Zeng">
    <meta name="description" content="I have recently been learning about Angr, a binary analysis framework developed by UC Santa Barbara and Arizona State University. It caught my eye because of its versatility and utility in reverse engineering binaries whose disassembly and decompilation are hard to understand manually. Oftentimes, it is simply due to the fact that it was compiled from newer or relatively less popular languages like Rust or Haskell, where the state of currently publicly available decompilers leaves much to be desired. Angr's ability to perform symbolic execution therefore allows us to blackbox certain functionality within the program (or even the entire program) by attempting to find the right input for a desired output.
">
    <meta name="keywords" content="fanpu, fan pu, fanpu zeng, fan pu zeng, zengfanpu, fanpuzeng, fzeng, CMU, cmu, carnegie mellon, cmu courses, school of computer science, scs, machine learning, computer science, ml, theory, courses, course reviews, CS, Jane Street">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    
    <!-- Sidebar Table of Contents -->
    <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet">
    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/favicon_new.ico">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://fanpu.io/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-1/">
    <!-- Dark Mode -->
    

    <!-- Twitter cards -->
    <meta name="twitter:site" content="@FanPu_Zeng">
    <meta name="twitter:creator" content="@fanpu">
    <meta name="og:title" content="Breaking CMU's Bomblab with Angr for Fun and Profit - Part 1">

    
    <meta name="twitter:card" content="summary_large_image">
    
    <meta name="og:image" content="https://fanpu.io/assets/img/posts/arapaho.webp">

    

    
    <meta name="og:description" content="I have recently been learning about Angr, a binary analysis framework developed by UC Santa Barbara and Arizona State University. It caught my eye because of its versatility and utility in reverse engineering binaries whose disassembly and decompilation are hard to understand manually. Oftentimes, it is simply due to the fact that it was compiled from newer or relatively less popular languages like Rust or Haskell, where the state of currently publicly available decompilers leaves much to be desired. Angr's ability to perform symbolic execution therefore allows us to blackbox certain functionality within the program (or even the entire program) by attempting to find the right input for a desired output.
">
    

    <!-- end of Twitter cards -->
  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Fan Pu </span>Zeng</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">About</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/courses/">CMU Course Reviews</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cmu-online/">CMU Online</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/summaries/">ML Paper Summaries</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">Repositories</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        
        <div class="row">
          <!-- sidebar, which will move to the top on a small screen -->
          <div class="col-sm-3">
            <nav id="toc-sidebar" class="sticky-top"></nav>
          </div>
          <!-- main content area -->
          <div class="col-sm-9">
            <!-- _layouts/post.html -->

<div class="post">

  <div style="display:none">
    $$
    \newcommand{\bone}{\mathbf{1}}
    \newcommand{\bbeta}{\mathbf{\beta}}
    \newcommand{\bdelta}{\mathbf{\delta}}
    \newcommand{\bepsilon}{\mathbf{\epsilon}}
    \newcommand{\blambda}{\mathbf{\lambda}}
    \newcommand{\bomega}{\mathbf{\omega}}
    \newcommand{\bpi}{\mathbf{\pi}}
    \newcommand{\bphi}{\mathbf{\phi}}
    \newcommand{\bvphi}{\mathbf{\varphi}}
    \newcommand{\bpsi}{\mathbf{\psi}}
    \newcommand{\bsigma}{\mathbf{\sigma}}
    \newcommand{\btheta}{\mathbf{\theta}}
    \newcommand{\btau}{\mathbf{\tau}}
    \newcommand{\ba}{\mathbf{a}}
    \newcommand{\bb}{\mathbf{b}}
    \newcommand{\bc}{\mathbf{c}}
    \newcommand{\bd}{\mathbf{d}}
    \newcommand{\be}{\mathbf{e}}
    \newcommand{\boldf}{\mathbf{f}}
    \newcommand{\bg}{\mathbf{g}}
    \newcommand{\bh}{\mathbf{h}}
    \newcommand{\bi}{\mathbf{i}}
    \newcommand{\bj}{\mathbf{j}}
    \newcommand{\bk}{\mathbf{k}}
    \newcommand{\bell}{\mathbf{\ell}}
    \newcommand{\bm}{\mathbf{m}}
    \newcommand{\bn}{\mathbf{n}}
    \newcommand{\bo}{\mathbf{o}}
    \newcommand{\bp}{\mathbf{p}}
    \newcommand{\bq}{\mathbf{q}}
    \newcommand{\br}{\mathbf{r}}
    \newcommand{\bs}{\mathbf{s}}
    \newcommand{\bt}{\mathbf{t}}
    \newcommand{\bu}{\mathbf{u}}
    \newcommand{\bv}{\mathbf{v}}
    \newcommand{\bw}{\mathbf{w}}
    \newcommand{\bx}{\mathbf{x}}
    \newcommand{\by}{\mathbf{y}}
    \newcommand{\bz}{\mathbf{z}}
    \newcommand{\bA}{\mathbf{A}}
    \newcommand{\bB}{\mathbf{B}}
    \newcommand{\bC}{\mathbf{C}}
    \newcommand{\bD}{\mathbf{D}}
    \newcommand{\bE}{\mathbf{E}}
    \newcommand{\bF}{\mathbf{F}}
    \newcommand{\bG}{\mathbf{G}}
    \newcommand{\bH}{\mathbf{H}}
    \newcommand{\bI}{\mathbf{I}}
    \newcommand{\bJ}{\mathbf{J}}
    \newcommand{\bK}{\mathbf{K}}
    \newcommand{\bL}{\mathbf{L}}
    \newcommand{\bM}{\mathbf{M}}
    \newcommand{\bN}{\mathbf{N}}
    \newcommand{\bP}{\mathbf{P}}
    \newcommand{\bQ}{\mathbf{Q}}
    \newcommand{\bR}{\mathbf{R}}
    \newcommand{\bS}{\mathbf{S}}
    \newcommand{\bT}{\mathbf{T}}
    \newcommand{\bU}{\mathbf{U}}
    \newcommand{\bV}{\mathbf{V}}
    \newcommand{\bW}{\mathbf{W}}
    \newcommand{\bX}{\mathbf{X}}
    \newcommand{\bY}{\mathbf{Y}}
    \newcommand{\bZ}{\mathbf{Z}}

    \newcommand{\bsa}{\boldsymbol{a}}
    \newcommand{\bsb}{\boldsymbol{b}}
    \newcommand{\bsc}{\boldsymbol{c}}
    \newcommand{\bsd}{\boldsymbol{d}}
    \newcommand{\bse}{\boldsymbol{e}}
    \newcommand{\bsoldf}{\boldsymbol{f}}
    \newcommand{\bsg}{\boldsymbol{g}}
    \newcommand{\bsh}{\boldsymbol{h}}
    \newcommand{\bsi}{\boldsymbol{i}}
    \newcommand{\bsj}{\boldsymbol{j}}
    \newcommand{\bsk}{\boldsymbol{k}}
    \newcommand{\bsell}{\boldsymbol{\ell}}
    \newcommand{\bsm}{\boldsymbol{m}}
    \newcommand{\bsn}{\boldsymbol{n}}
    \newcommand{\bso}{\boldsymbol{o}}
    \newcommand{\bsp}{\boldsymbol{p}}
    \newcommand{\bsq}{\boldsymbol{q}}
    \newcommand{\bsr}{\boldsymbol{r}}
    \newcommand{\bss}{\boldsymbol{s}}
    \newcommand{\bst}{\boldsymbol{t}}
    \newcommand{\bsu}{\boldsymbol{u}}
    \newcommand{\bsv}{\boldsymbol{v}}
    \newcommand{\bsw}{\boldsymbol{w}}
    \newcommand{\bsx}{\boldsymbol{x}}
    \newcommand{\bsy}{\boldsymbol{y}}
    \newcommand{\bsz}{\boldsymbol{z}}
    \newcommand{\bsA}{\boldsymbol{A}}
    \newcommand{\bsB}{\boldsymbol{B}}
    \newcommand{\bsC}{\boldsymbol{C}}
    \newcommand{\bsD}{\boldsymbol{D}}
    \newcommand{\bsE}{\boldsymbol{E}}
    \newcommand{\bsF}{\boldsymbol{F}}
    \newcommand{\bsG}{\boldsymbol{G}}
    \newcommand{\bsH}{\boldsymbol{H}}
    \newcommand{\bsI}{\boldsymbol{I}}
    \newcommand{\bsJ}{\boldsymbol{J}}
    \newcommand{\bsK}{\boldsymbol{K}}
    \newcommand{\bsL}{\boldsymbol{L}}
    \newcommand{\bsM}{\boldsymbol{M}}
    \newcommand{\bsN}{\boldsymbol{N}}
    \newcommand{\bsP}{\boldsymbol{P}}
    \newcommand{\bsQ}{\boldsymbol{Q}}
    \newcommand{\bsR}{\boldsymbol{R}}
    \newcommand{\bsS}{\boldsymbol{S}}
    \newcommand{\bsT}{\boldsymbol{T}}
    \newcommand{\bsU}{\boldsymbol{U}}
    \newcommand{\bsV}{\boldsymbol{V}}
    \newcommand{\bsW}{\boldsymbol{W}}
    \newcommand{\bsX}{\boldsymbol{X}}
    \newcommand{\bsY}{\boldsymbol{Y}}
    \newcommand{\bsZ}{\boldsymbol{Z}}

    \newcommand{\calA}{\mathcal{A}}
    \newcommand{\calB}{\mathcal{B}}
    \newcommand{\calC}{\mathcal{C}}
    \newcommand{\calD}{\mathcal{D}}
    \newcommand{\calE}{\mathcal{E}}
    \newcommand{\calF}{\mathcal{F}}
    \newcommand{\calG}{\mathcal{G}}
    \newcommand{\calH}{\mathcal{H}}
    \newcommand{\calI}{\mathcal{I}}
    \newcommand{\calJ}{\mathcal{J}}
    \newcommand{\calK}{\mathcal{K}}
    \newcommand{\calL}{\mathcal{L}}
    \newcommand{\calM}{\mathcal{M}}
    \newcommand{\calN}{\mathcal{N}}
    \newcommand{\calO}{\mathcal{O}}
    \newcommand{\calP}{\mathcal{P}}
    \newcommand{\calQ}{\mathcal{Q}}
    \newcommand{\calR}{\mathcal{R}}
    \newcommand{\calS}{\mathcal{S}}
    \newcommand{\calT}{\mathcal{T}}
    \newcommand{\calU}{\mathcal{U}}
    \newcommand{\calV}{\mathcal{V}}
    \newcommand{\calW}{\mathcal{W}}
    \newcommand{\calX}{\mathcal{X}}
    \newcommand{\calY}{\mathcal{Y}}
    \newcommand{\calZ}{\mathcal{Z}}

    \newcommand{\R}{\mathbb{R}}
    \newcommand{\C}{\mathbb{C}}
    \newcommand{\N}{\mathbb{N}}
    \newcommand{\Z}{\mathbb{Z}}
    \newcommand{\F}{\mathbb{F}}
    \newcommand{\Q}{\mathbb{Q}}

    \DeclareMathOperator*{\argmax}{arg\,max}
    \DeclareMathOperator*{\argmin}{arg\,min}
    \newcommand{\nnz}[1]{\mbox{nnz}(#1)}
    \newcommand{\dotprod}[2]{\langle #1, #2 \rangle}

    \newcommand{\ignore}[1]{}

    \let\Pr\relax
    \DeclareMathOperator*{\Pr}{\mathbf{Pr}}
    \newcommand{\E}{\mathbb{E}}
    \DeclareMathOperator*{\Ex}{\mathbf{E}}
    \DeclareMathOperator*{\Var}{\mathbf{Var}}
    \DeclareMathOperator*{\Cov}{\mathbf{Cov}}
    \DeclareMathOperator*{\stddev}{\mathbf{stddev}}
    \DeclareMathOperator*{\avg}{avg}

    \DeclareMathOperator{\poly}{poly}
    \DeclareMathOperator{\polylog}{polylog}
    \DeclareMathOperator{\size}{size}
    \DeclareMathOperator{\sgn}{sgn}
    \DeclareMathOperator{\dist}{dist}
    \DeclareMathOperator{\vol}{vol}
    \DeclareMathOperator{\spn}{span}
    \DeclareMathOperator{\supp}{supp}
    \DeclareMathOperator{\tr}{tr}
    \DeclareMathOperator{\Tr}{Tr}
    \DeclareMathOperator{\codim}{codim}
    \DeclareMathOperator{\diag}{diag}

    \newcommand{\PTIME}{\mathsf{P}}
    \newcommand{\LOGSPACE}{\mathsf{L}}
    \newcommand{\ZPP}{\mathsf{ZPP}}
    \newcommand{\RP}{\mathsf{RP}}
    \newcommand{\BPP}{\mathsf{BPP}}
    \newcommand{\P}{\mathsf{P}}
    \newcommand{\NP}{\mathsf{NP}}
    \newcommand{\TC}{\mathsf{TC}}
    \newcommand{\AC}{\mathsf{AC}}
    \newcommand{\SC}{\mathsf{SC}}
    \newcommand{\SZK}{\mathsf{SZK}}
    \newcommand{\AM}{\mathsf{AM}}
    \newcommand{\IP}{\mathsf{IP}}
    \newcommand{\PSPACE}{\mathsf{PSPACE}}
    \newcommand{\EXP}{\mathsf{EXP}}
    \newcommand{\MIP}{\mathsf{MIP}}
    \newcommand{\NEXP}{\mathsf{NEXP}}
    \newcommand{\BQP}{\mathsf{BQP}}
    \newcommand{\distP}{\mathsf{dist\textbf{P}}}
    \newcommand{\distNP}{\mathsf{dist\textbf{NP}}}

    \newcommand{\eps}{\epsilon}
    \newcommand{\lam}{\lambda}
    \newcommand{\dleta}{\delta}
    \newcommand{\simga}{\sigma}
    \newcommand{\vphi}{\varphi}
    \newcommand{\la}{\langle}
    \newcommand{\ra}{\rangle}
    \newcommand{\wt}[1]{\widetilde{#1}}
    \newcommand{\wh}[1]{\widehat{#1}}
    \newcommand{\ol}[1]{\overline{#1}}
    \newcommand{\ul}[1]{\underline{#1}}
    \newcommand{\ot}{\otimes}
    \newcommand{\zo}{\{0,1\}}
    \newcommand{\co}{:} %\newcommand{\co}{\colon}
    \newcommand{\bdry}{\partial}
    \newcommand{\grad}{\nabla}
    \newcommand{\transp}{^\intercal}
    \newcommand{\inv}{^{-1}}
    \newcommand{\symmdiff}{\triangle} \newcommand{\symdiff}{\symmdiff}
    \newcommand{\half}{\tfrac{1}{2}}
    \newcommand{\bbone}{\mathbbm 1}
    \newcommand{\Id}{\bbone}

    \newcommand{\SAT}{\mathsf{SAT}}

    \newcommand{\bcalG}{\boldsymbol{\calG}}
    \newcommand{\calbG}{\bcalG}
    \newcommand{\bcalX}{\boldsymbol{\calX}} \newcommand{\calbX}{\bcalX}
    \newcommand{\bcalY}{\boldsymbol{\calY}} \newcommand{\calbY}{\bcalY}
    \newcommand{\bcalZ}{\boldsymbol{\calZ}} \newcommand{\calbZ}{\bcalZ}
    $$
</div>

  <header class="post-header">
    <h1 class="post-title">Breaking CMU's Bomblab with Angr for Fun and Profit - Part 1</h1>
    <p class="post-meta">July 30, 2020• fanpu</p>
    <p class="post-tags">
      <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>
        ·  
        <a href="/blog/tag/rev">
          <i class="fas fa-hashtag fa-sm"></i> rev</a>  
          <a href="/blog/tag/ctf">
          <i class="fas fa-hashtag fa-sm"></i> ctf</a>  
          <a href="/blog/tag/code">
          <i class="fas fa-hashtag fa-sm"></i> code</a>  
          

    </p>
  </header>

  
      <figure>
  <picture>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/posts/arapaho.webp" class="preview z-depth-1 rounded center" width="100%" height="450px" alt="post.cover" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">

  </picture>
</figure>

    <div class="caption">
        Arapaho Glacier, Roosevelt National Forest, Colorado, USA
    </div>
  

  <article class="post-content">
    
    <div id="markdown-content">
      <p>I have recently been learning about <a href="https://angr.io/" rel="external nofollow noopener" target="_blank">Angr</a>, a binary analysis
framework developed by UC Santa Barbara and Arizona State University. It caught
my eye because of its versatility and utility in reverse engineering binaries
whose disassembly and decompilation are hard to understand manually. Oftentimes,
it is simply due to the fact that it was compiled from newer or relatively less
popular languages like Rust or Haskell, where the state of currently publicly
available decompilers leaves much to be desired. Angr’s ability to perform
symbolic execution therefore allows us to blackbox certain functionality within
the program (or even the entire program) by attempting to find the right input
for a desired output.</p>

<h3 id="but-what-is-symbolic-execution-anyway">But what is symbolic execution anyway?</h3>
<p>Do you recall when you had to first begin manipulating symbols in math class during elementary school? Yes, algebra! Symbolic execution can be thought of as manipulating symbols in order to derive certain constraints. These constraints can then be solved by a Satisfiability Modulo Theories (SMT) solver like <a href="https://github.com/Z3Prover/z3" rel="external nofollow noopener" target="_blank">Z3</a>.</p>

<p>Here is a simple example:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="code"><pre><span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">print_flag</span><span class="p">();</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Suppose we want Angr to figure out how how to reach line 5 (<code class="language-plaintext highlighter-rouge">print_flag</code>) of the program during its execution. From a very high level, you can tell Angr that the instruction corresponding to what happens at line 4 is an address that you want it to find, and Angr will be able to work backwards and deduce symbolically that we need to constrain <code class="language-plaintext highlighter-rouge">y = 20</code>, which implies that we have to then constrain <code class="language-plaintext highlighter-rouge">x=15</code>, and so the user input from stdin must correspond to 15.</p>

<p>Of course, this is a very contrived example, and in practice the constraints are usually in ranges (i.e <code class="language-plaintext highlighter-rouge">x &gt; 0</code>), and you can end up with a lot of potential inputs for a desired output (maybe even infinitely many). When situations like this happens, you can ask Angr to return an arbitrary valid input, or return <code class="language-plaintext highlighter-rouge">n</code> such inputs, and many other options which you can refer to <a href="https://docs.angr.io/core-concepts/solver#more-solving-methods" rel="external nofollow noopener" target="_blank">here</a>.</p>

<h3 id="bomblab">Bomblab</h3>
<p>Now that we have a basic understanding of what Angr is and what symbolic execution is about, let’s put our newfound skills to the test! I decided to try it out with Carnegie Mellon’s Bomb Lab (you can download it <a href="http://csapp.cs.cmu.edu/3e/bomb.tar" rel="external nofollow noopener" target="_blank">here</a>). It is the second lab for the class 15-213 Introduction to Computer Systems in CMU which I took last year, and which is a required class for all computer science majors. Back then when I took the class, I printed out the disassembly from <code class="language-plaintext highlighter-rouge">objdump</code> onto paper and traced all of the function calls and loops manually. I also did some basic dynamic analysis with <code class="language-plaintext highlighter-rouge">gdb</code> to debug my inputs and confirm that my intuition for what was happening was correct. It was a slow but fun and rewarding process.</p>

<p>Let’s see how easily we can solve Bomblab with Angr together! I have structured this walkthrough into 7 separate posts, one post for each phase of the bomb (including the secret phase). I will also approach it without relying on any prior knowledge of the phases. Without further ado, let’s get started!</p>

<h3 id="phase-1">Phase 1</h3>
<p>It’s always good to first check the attributes of the binary. The main thing I am concerned about is PIE (position independent code), because that would potentially make referencing addresses more difficult (Angr does have support for PIE though):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="code"><pre><span class="nv">$ </span>checksec bomb
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Awesome, we see that there is no PIE, and that this is also a 64 bit binary.</p>

<p>Let’s create a new Angr project skeleton:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="code"><pre><span class="kn">import</span> <span class="n">angr</span>
<span class="kn">import</span> <span class="n">claripy</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">def</span> <span class="nf">phase_1</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="c1"># Create an Angr project.
</span>    <span class="n">path_to_binary</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># :string
</span>    <span class="n">project</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="nc">Project</span><span class="p">(</span><span class="n">path_to_binary</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">phase_1</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Now let’s look at the disassembly in gdb (truncated to the interesting parts for brevity):</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td>
<td class="code"><pre>   <span class="mh">0x0000000000400e19</span> <span class="o">&lt;+</span><span class="mi">121</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4013a2</span> <span class="o">&lt;</span><span class="n">initialize_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e1e</span> <span class="o">&lt;+</span><span class="mi">126</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x402338</span>
   <span class="mh">0x0000000000400e23</span> <span class="o">&lt;+</span><span class="mi">131</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e28</span> <span class="o">&lt;+</span><span class="mi">136</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x402378</span>
   <span class="mh">0x0000000000400e2d</span> <span class="o">&lt;+</span><span class="mi">141</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e32</span> <span class="o">&lt;+</span><span class="mi">146</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e37</span> <span class="o">&lt;+</span><span class="mi">151</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400e3a</span> <span class="o">&lt;+</span><span class="mi">154</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400ee0</span> <span class="o">&lt;</span><span class="n">phase_1</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e3f</span> <span class="o">&lt;+</span><span class="mi">159</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e44</span> <span class="o">&lt;+</span><span class="mi">164</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4023a8</span>
   <span class="mh">0x0000000000400e49</span> <span class="o">&lt;+</span><span class="mi">169</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e4e</span> <span class="o">&lt;+</span><span class="mi">174</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e53</span> <span class="o">&lt;+</span><span class="mi">179</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400e56</span> <span class="o">&lt;+</span><span class="mi">182</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400efc</span> <span class="o">&lt;</span><span class="n">phase_2</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e5b</span> <span class="o">&lt;+</span><span class="mi">187</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e60</span> <span class="o">&lt;+</span><span class="mi">192</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4022ed</span>
   <span class="mh">0x0000000000400e65</span> <span class="o">&lt;+</span><span class="mi">197</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e6a</span> <span class="o">&lt;+</span><span class="mi">202</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e6f</span> <span class="o">&lt;+</span><span class="mi">207</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400e72</span> <span class="o">&lt;+</span><span class="mi">210</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400f43</span> <span class="o">&lt;</span><span class="n">phase_3</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e77</span> <span class="o">&lt;+</span><span class="mi">215</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e7c</span> <span class="o">&lt;+</span><span class="mi">220</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40230b</span>
   <span class="mh">0x0000000000400e81</span> <span class="o">&lt;+</span><span class="mi">225</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e86</span> <span class="o">&lt;+</span><span class="mi">230</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e8b</span> <span class="o">&lt;+</span><span class="mi">235</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400e8e</span> <span class="o">&lt;+</span><span class="mi">238</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40100c</span> <span class="o">&lt;</span><span class="n">phase_4</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e93</span> <span class="o">&lt;+</span><span class="mi">243</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400e98</span> <span class="o">&lt;+</span><span class="mi">248</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4023d8</span>
   <span class="mh">0x0000000000400e9d</span> <span class="o">&lt;+</span><span class="mi">253</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ea2</span> <span class="o">&lt;+</span><span class="mi">258</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ea7</span> <span class="o">&lt;+</span><span class="mi">263</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400eaa</span> <span class="o">&lt;+</span><span class="mi">266</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x401062</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400eaf</span> <span class="o">&lt;+</span><span class="mi">271</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400eb4</span> <span class="o">&lt;+</span><span class="mi">276</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40231a</span>
   <span class="mh">0x0000000000400eb9</span> <span class="o">&lt;+</span><span class="mi">281</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ebe</span> <span class="o">&lt;+</span><span class="mi">286</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40149e</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ec3</span> <span class="o">&lt;+</span><span class="mi">291</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000400ec6</span> <span class="o">&lt;+</span><span class="mi">294</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4010f4</span> <span class="o">&lt;</span><span class="n">phase_6</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ecb</span> <span class="o">&lt;+</span><span class="mi">299</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4015c4</span> <span class="o">&lt;</span><span class="n">phase_defused</span><span class="o">&gt;</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Here we see that there are 6 phases in the <code class="language-plaintext highlighter-rouge">main</code> function, which are logically isolated from one another. We also see that it calls a <code class="language-plaintext highlighter-rouge">read_line</code> function, which is not a standard glibc function. Let’s look at <code class="language-plaintext highlighter-rouge">phase_1</code>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">disas</span> <span class="n">phase_1</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">phase_1</span><span class="o">:</span>
   <span class="mh">0x0000000000400ee0</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x0000000000400ee4</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">esi</span><span class="p">,</span><span class="mh">0x402400</span>
   <span class="mh">0x0000000000400ee9</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x401338</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400eee</span> <span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x0000000000400ef0</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x400ef7</span> <span class="o">&lt;</span><span class="n">phase_1</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ef2</span> <span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40143a</span> <span class="o">&lt;</span><span class="n">explode_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ef7</span> <span class="o">&lt;+</span><span class="mi">23</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x0000000000400efb</span> <span class="o">&lt;+</span><span class="mi">27</span><span class="o">&gt;:</span>	<span class="n">ret</span> 
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>What it does is really simple - compare the user input to the string at 0x402400, and we easily solve it without Angr. But let’s try doing it with Angr anyway, because it will yield several valuable learning points.</p>

<p>The first thing to take note of is that user input is being read with a custom <code class="language-plaintext highlighter-rouge">read_line</code> function. Let’s take a look at that:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td>
<td class="code"><pre>   <span class="mh">0x000000000040149e</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x00000000004014a2</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004014a7</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4013f9</span> <span class="o">&lt;</span><span class="n">skip</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014ac</span> <span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">rax</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x00000000004014af</span> <span class="o">&lt;+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x40151f</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">+</span><span class="mi">129</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014b1</span> <span class="o">&lt;+</span><span class="mi">19</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x202290</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603748</span> <span class="o">&lt;</span><span class="n">stdin</span><span class="err">@@</span><span class="n">GLIBC_2</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014b8</span> <span class="o">&lt;+</span><span class="mi">26</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2022a9</span><span class="p">],</span><span class="n">rax</span>        <span class="err">#</span> <span class="mh">0x603768</span> <span class="o">&lt;</span><span class="n">infile</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014bf</span> <span class="o">&lt;+</span><span class="mi">33</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x4014d5</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">+</span><span class="mi">55</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014c1</span> <span class="o">&lt;+</span><span class="mi">35</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4025d5</span>
   <span class="mh">0x00000000004014c6</span> <span class="o">&lt;+</span><span class="mi">40</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014cb</span> <span class="o">&lt;+</span><span class="mi">45</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x00000000004014d0</span> <span class="o">&lt;+</span><span class="mi">50</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400c20</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014d5</span> <span class="o">&lt;+</span><span class="mi">55</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4025f3</span>
   <span class="mh">0x00000000004014da</span> <span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400ae0</span> <span class="o">&lt;</span><span class="n">getenv</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014df</span> <span class="o">&lt;+</span><span class="mi">65</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">rax</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x00000000004014e2</span> <span class="o">&lt;+</span><span class="mi">68</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x4014ee</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014e4</span> <span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004014e9</span> <span class="o">&lt;+</span><span class="mi">75</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400c20</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014ee</span> <span class="o">&lt;+</span><span class="mi">80</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x202253</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603748</span> <span class="o">&lt;</span><span class="n">stdin</span><span class="err">@@</span><span class="n">GLIBC_2</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014f5</span> <span class="o">&lt;+</span><span class="mi">87</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x20226c</span><span class="p">],</span><span class="n">rax</span>        <span class="err">#</span> <span class="mh">0x603768</span> <span class="o">&lt;</span><span class="n">infile</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004014fc</span> <span class="o">&lt;+</span><span class="mi">94</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x0000000000401501</span> <span class="o">&lt;+</span><span class="mi">99</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4013f9</span> <span class="o">&lt;</span><span class="n">skip</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401506</span> <span class="o">&lt;+</span><span class="mi">104</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">rax</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000401509</span> <span class="o">&lt;+</span><span class="mi">107</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x40151f</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">+</span><span class="mi">129</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040150b</span> <span class="o">&lt;+</span><span class="mi">109</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4025d5</span>
   <span class="mh">0x0000000000401510</span> <span class="o">&lt;+</span><span class="mi">114</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401515</span> <span class="o">&lt;+</span><span class="mi">119</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x000000000040151a</span> <span class="o">&lt;+</span><span class="mi">124</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400c20</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040151f</span> <span class="o">&lt;+</span><span class="mi">129</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x20223b</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603760</span> <span class="o">&lt;</span><span class="n">num_input_strings</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401525</span> <span class="o">&lt;+</span><span class="mi">135</span><span class="o">&gt;:</span>	<span class="n">movsxd</span> <span class="n">rax</span><span class="p">,</span><span class="n">edx</span>
   <span class="mh">0x0000000000401528</span> <span class="o">&lt;+</span><span class="mi">138</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">rsi</span><span class="p">,[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
   <span class="mh">0x000000000040152c</span> <span class="o">&lt;+</span><span class="mi">142</span><span class="o">&gt;:</span>	<span class="n">shl</span>    <span class="n">rsi</span><span class="p">,</span><span class="mh">0x4</span>
   <span class="mh">0x0000000000401530</span> <span class="o">&lt;+</span><span class="mi">146</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rsi</span><span class="p">,</span><span class="mh">0x603780</span>
   <span class="mh">0x0000000000401537</span> <span class="o">&lt;+</span><span class="mi">153</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rsi</span>
   <span class="mh">0x000000000040153a</span> <span class="o">&lt;+</span><span class="mi">156</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x000000000040153f</span> <span class="o">&lt;+</span><span class="mi">161</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span><span class="mh">0xffffffffffffffff</span>
   <span class="mh">0x0000000000401546</span> <span class="o">&lt;+</span><span class="mi">168</span><span class="o">&gt;:</span>	<span class="n">repnz</span> <span class="n">scas</span> <span class="n">al</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="n">es</span><span class="o">:</span><span class="p">[</span><span class="n">rdi</span><span class="p">]</span>
   <span class="mh">0x0000000000401548</span> <span class="o">&lt;+</span><span class="mi">170</span><span class="o">&gt;:</span>	<span class="n">not</span>    <span class="n">rcx</span>
   <span class="mh">0x000000000040154b</span> <span class="o">&lt;+</span><span class="mi">173</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rcx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x000000000040154f</span> <span class="o">&lt;+</span><span class="mi">177</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">ecx</span><span class="p">,</span><span class="mh">0x4e</span>
   <span class="mh">0x0000000000401552</span> <span class="o">&lt;+</span><span class="mi">180</span><span class="o">&gt;:</span>	<span class="n">jle</span>    <span class="mh">0x40159a</span> <span class="o">&lt;</span><span class="n">read_line</span><span class="o">+</span><span class="mi">252</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401554</span> <span class="o">&lt;+</span><span class="mi">182</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4025fe</span>
   <span class="mh">0x0000000000401559</span> <span class="o">&lt;+</span><span class="mi">187</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b10</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040155e</span> <span class="o">&lt;+</span><span class="mi">192</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2021fc</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603760</span> <span class="o">&lt;</span><span class="n">num_input_strings</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401564</span> <span class="o">&lt;+</span><span class="mi">198</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">edx</span><span class="p">,[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x1</span><span class="p">]</span>
   <span class="mh">0x0000000000401567</span> <span class="o">&lt;+</span><span class="mi">201</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2021f3</span><span class="p">],</span><span class="n">edx</span>        <span class="err">#</span> <span class="mh">0x603760</span> <span class="o">&lt;</span><span class="n">num_input_strings</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040156d</span> <span class="o">&lt;+</span><span class="mi">207</span><span class="o">&gt;:</span>	<span class="n">cdqe</span>   
   <span class="mh">0x000000000040156f</span> <span class="o">&lt;+</span><span class="mi">209</span><span class="o">&gt;:</span>	<span class="n">imul</span>   <span class="n">rax</span><span class="p">,</span><span class="n">rax</span><span class="p">,</span><span class="mh">0x50</span>
   <span class="mh">0x0000000000401573</span> <span class="o">&lt;+</span><span class="mi">213</span><span class="o">&gt;:</span>	<span class="n">movabs</span> <span class="n">rdi</span><span class="p">,</span><span class="mh">0x636e7572742a2a2a</span>
   <span class="mh">0x000000000040157d</span> <span class="o">&lt;+</span><span class="mi">223</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x603780</span><span class="p">],</span><span class="n">rdi</span>
   <span class="mh">0x0000000000401584</span> <span class="o">&lt;+</span><span class="mi">230</span><span class="o">&gt;:</span>	<span class="n">movabs</span> <span class="n">rdi</span><span class="p">,</span><span class="mh">0x2a2a2a64657461</span>
   <span class="mh">0x000000000040158e</span> <span class="o">&lt;+</span><span class="mi">240</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x603788</span><span class="p">],</span><span class="n">rdi</span>
   <span class="mh">0x0000000000401595</span> <span class="o">&lt;+</span><span class="mi">247</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40143a</span> <span class="o">&lt;</span><span class="n">explode_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040159a</span> <span class="o">&lt;+</span><span class="mi">252</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">ecx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x000000000040159d</span> <span class="o">&lt;+</span><span class="mi">255</span><span class="o">&gt;:</span>	<span class="n">movsxd</span> <span class="n">rcx</span><span class="p">,</span><span class="n">ecx</span>
   <span class="mh">0x00000000004015a0</span> <span class="o">&lt;+</span><span class="mi">258</span><span class="o">&gt;:</span>	<span class="n">movsxd</span> <span class="n">rax</span><span class="p">,</span><span class="n">edx</span>
   <span class="mh">0x00000000004015a3</span> <span class="o">&lt;+</span><span class="mi">261</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">rax</span><span class="p">,[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
   <span class="mh">0x00000000004015a7</span> <span class="o">&lt;+</span><span class="mi">265</span><span class="o">&gt;:</span>	<span class="n">shl</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x4</span>
   <span class="mh">0x00000000004015ab</span> <span class="o">&lt;+</span><span class="mi">269</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x603780</span><span class="p">],</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004015b3</span> <span class="o">&lt;+</span><span class="mi">277</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x00000000004015b6</span> <span class="o">&lt;+</span><span class="mi">280</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2021a4</span><span class="p">],</span><span class="n">edx</span>        <span class="err">#</span> <span class="mh">0x603760</span> <span class="o">&lt;</span><span class="n">num_input_strings</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004015bc</span> <span class="o">&lt;+</span><span class="mi">286</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">rsi</span>
   <span class="mh">0x00000000004015bf</span> <span class="o">&lt;+</span><span class="mi">289</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x00000000004015c3</span> <span class="o">&lt;+</span><span class="mi">293</span><span class="o">&gt;:</span>	<span class="n">ret</span>    
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>We don’t see any functions which reads in input directly being called, like scanf, read, or fgets. Digging further though, we see that the input is actually being read in the <code class="language-plaintext highlighter-rouge">skip</code> function, which calls fgets:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">disas</span> <span class="mh">0x4013f9</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">skip</span><span class="o">:</span>
   <span class="mh">0x00000000004013f9</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">rbx</span>
   <span class="mh">0x00000000004013fa</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="n">movsxd</span> <span class="n">rax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x20235f</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603760</span> <span class="o">&lt;</span><span class="n">num_input_strings</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401401</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">rdi</span><span class="p">,[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
   <span class="mh">0x0000000000401405</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;:</span>	<span class="n">shl</span>    <span class="n">rdi</span><span class="p">,</span><span class="mh">0x4</span>
   <span class="mh">0x0000000000401409</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rdi</span><span class="p">,</span><span class="mh">0x603780</span>
   <span class="mh">0x0000000000401410</span> <span class="o">&lt;+</span><span class="mi">23</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x202351</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x603768</span> <span class="o">&lt;</span><span class="n">infile</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401417</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">esi</span><span class="p">,</span><span class="mh">0x50</span>
   <span class="mh">0x000000000040141c</span> <span class="o">&lt;+</span><span class="mi">35</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b80</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401421</span> <span class="o">&lt;+</span><span class="mi">40</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000401424</span> <span class="o">&lt;+</span><span class="mi">43</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">rax</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x0000000000401427</span> <span class="o">&lt;+</span><span class="mi">46</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x401435</span> <span class="o">&lt;</span><span class="n">skip</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401429</span> <span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rax</span>
   <span class="mh">0x000000000040142c</span> <span class="o">&lt;+</span><span class="mi">51</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x4013bc</span> <span class="o">&lt;</span><span class="n">blank_line</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401431</span> <span class="o">&lt;+</span><span class="mi">56</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x0000000000401433</span> <span class="o">&lt;+</span><span class="mi">58</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x4013fa</span> <span class="o">&lt;</span><span class="n">skip</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401435</span> <span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">rbx</span>
   <span class="mh">0x0000000000401438</span> <span class="o">&lt;+</span><span class="mi">63</span><span class="o">&gt;:</span>	<span class="n">pop</span>    <span class="n">rbx</span>
   <span class="mh">0x0000000000401439</span> <span class="o">&lt;+</span><span class="mi">64</span><span class="o">&gt;:</span>	<span class="n">ret</span>    
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>The point here is that we don’t want to reverse precisely what <code class="language-plaintext highlighter-rouge">read_line</code> does, and just rely on our intuition that it basically reads in a line. We also see that there are a couple of checks in the loops, which can potentially lead to state explosion.</p>

<h3 id="state-explosion">State Explosion</h3>
<p>State explosion is an extremely important concept in symbolic execution, and it is the primary reason why achieving general symbolic execution is hard. With every branch, our number of states double. This exponential growth in the number of states can quickly render our search infeasible, which is why it is important for us to limit the number of potential paths as much as possible. Doing this automatically is currently an area of active research. There is a great paper from CMU titled <a href="https://users.ece.cmu.edu/~aavgerin/papers/veritesting-icse-2014.pdf" rel="external nofollow noopener" target="_blank">Enhancing Symbolic Execution with Veritesting</a>, which introduces the idea of veritesting in order to mitigate state explosion. This is achieved by combining both static and dynamic symbolic execution to produce heuristics to avoid states which are likely to lead to failure, and by combining branches. Angr does support veritesting in its simulation manager, but this is out of scope for this series. Do read the paper if you are interested for more!</p>

<p>In order to prevent that, we will inject our own symbolic memory for the input instead, and bypass the <code class="language-plaintext highlighter-rouge">read_line</code> function entirely.</p>

<p>If we look at the disassembly for <code class="language-plaintext highlighter-rouge">main</code>, the place where we call <code class="language-plaintext highlighter-rouge">phase_1</code> is a good point to start program execution. We can then simply pass the symbolic input in the <code class="language-plaintext highlighter-rouge">rdi</code> register!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="code"><pre>    <span class="c1"># Tell Angr where to start executing 
</span>    <span class="n">start_addr</span> <span class="o">=</span> <span class="mh">0x00400e3a</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">start_addr</span><span class="p">)</span>

    <span class="n">fake_addr</span> <span class="o">=</span> <span class="mh">0x40000000</span>
    <span class="n">phase_1_input</span> <span class="o">=</span> <span class="n">claripy</span><span class="p">.</span><span class="nc">BVS</span><span class="p">(</span><span class="sh">'</span><span class="s">phase_1_input</span><span class="sh">'</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">fake_addr</span><span class="p">,</span> <span class="n">phase_1_input</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">fake_addr</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">claripy.BVS</code> creates a symbolic value referred to by <code class="language-plaintext highlighter-rouge">phase_1_input</code>, with a size of 100 bytes or 100 * 8 bits. 100 bytes should be big enough, if Angr is unable to find a solution, we can always add more. BVS stands for bit vector symbolic. It has a cousin, BVV, which stands for bit vector value, that holds concrete values. Our string input value is stored at <code class="language-plaintext highlighter-rouge">fake_addr</code>. <code class="language-plaintext highlighter-rouge">fake_addr</code> was chosen arbitrarily, it can simply be any area of memory not being used by any of the other sections (text, heap, stack, libs) during execution. So with this, we have now a reference to our symbolic bit vector in <code class="language-plaintext highlighter-rouge">rdi</code>!</p>

<p>Now, if we look back at the disassembly for <code class="language-plaintext highlighter-rouge">phase_1</code>, we see that it primarily calls <code class="language-plaintext highlighter-rouge">strings_not_equal</code>. We have a hunch about what it does, let’s look at it in assembly:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td>
<td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">disas</span> <span class="n">strings_not_equal</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">strings_not_equal</span><span class="o">:</span>
   <span class="mh">0x0000000000401338</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">r12</span>
   <span class="mh">0x000000000040133a</span> <span class="o">&lt;+</span><span class="mi">2</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">rbp</span>
   <span class="mh">0x000000000040133b</span> <span class="o">&lt;+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">rbx</span>
   <span class="mh">0x000000000040133c</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">rdi</span>
   <span class="mh">0x000000000040133f</span> <span class="o">&lt;+</span><span class="mi">7</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rbp</span><span class="p">,</span><span class="n">rsi</span>
   <span class="mh">0x0000000000401342</span> <span class="o">&lt;+</span><span class="mi">10</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40131b</span> <span class="o">&lt;</span><span class="n">string_length</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401347</span> <span class="o">&lt;+</span><span class="mi">15</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">r12d</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x000000000040134a</span> <span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span><span class="n">rbp</span>
   <span class="mh">0x000000000040134d</span> <span class="o">&lt;+</span><span class="mi">21</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40131b</span> <span class="o">&lt;</span><span class="n">string_length</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401352</span> <span class="o">&lt;+</span><span class="mi">26</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x0000000000401357</span> <span class="o">&lt;+</span><span class="mi">31</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">r12d</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x000000000040135a</span> <span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x40139b</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040135c</span> <span class="o">&lt;+</span><span class="mi">36</span><span class="o">&gt;:</span>	<span class="n">movzx</span>  <span class="n">eax</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbx</span><span class="p">]</span>
   <span class="mh">0x000000000040135f</span> <span class="o">&lt;+</span><span class="mi">39</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">al</span><span class="p">,</span><span class="n">al</span>
   <span class="mh">0x0000000000401361</span> <span class="o">&lt;+</span><span class="mi">41</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x401388</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401363</span> <span class="o">&lt;+</span><span class="mi">43</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">al</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
   <span class="mh">0x0000000000401366</span> <span class="o">&lt;+</span><span class="mi">46</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x401372</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">58</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401368</span> <span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x40138f</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040136a</span> <span class="o">&lt;+</span><span class="mi">50</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">al</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
   <span class="mh">0x000000000040136d</span> <span class="o">&lt;+</span><span class="mi">53</span><span class="o">&gt;:</span>	<span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>
   <span class="mh">0x0000000000401370</span> <span class="o">&lt;+</span><span class="mi">56</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x401396</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401372</span> <span class="o">&lt;+</span><span class="mi">58</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rbx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x0000000000401376</span> <span class="o">&lt;+</span><span class="mi">62</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rbp</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x000000000040137a</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span>	<span class="n">movzx</span>  <span class="n">eax</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbx</span><span class="p">]</span>
   <span class="mh">0x000000000040137d</span> <span class="o">&lt;+</span><span class="mi">69</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">al</span><span class="p">,</span><span class="n">al</span>
   <span class="mh">0x000000000040137f</span> <span class="o">&lt;+</span><span class="mi">71</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x40136a</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">50</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401381</span> <span class="o">&lt;+</span><span class="mi">73</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x0000000000401386</span> <span class="o">&lt;+</span><span class="mi">78</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x40139b</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401388</span> <span class="o">&lt;+</span><span class="mi">80</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x000000000040138d</span> <span class="o">&lt;+</span><span class="mi">85</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x40139b</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040138f</span> <span class="o">&lt;+</span><span class="mi">87</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x0000000000401394</span> <span class="o">&lt;+</span><span class="mi">92</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x40139b</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401396</span> <span class="o">&lt;+</span><span class="mi">94</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x000000000040139b</span> <span class="o">&lt;+</span><span class="mi">99</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">edx</span>
   <span class="mh">0x000000000040139d</span> <span class="o">&lt;+</span><span class="mi">101</span><span class="o">&gt;:</span>	<span class="n">pop</span>    <span class="n">rbx</span>
   <span class="mh">0x000000000040139e</span> <span class="o">&lt;+</span><span class="mi">102</span><span class="o">&gt;:</span>	<span class="n">pop</span>    <span class="n">rbp</span>
   <span class="mh">0x000000000040139f</span> <span class="o">&lt;+</span><span class="mi">103</span><span class="o">&gt;:</span>	<span class="n">pop</span>    <span class="n">r12</span>
   <span class="mh">0x00000000004013a1</span> <span class="o">&lt;+</span><span class="mi">105</span><span class="o">&gt;:</span>	<span class="n">ret</span>    
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Again, we see lots of comparisons and jumps, which is what we don’t like since it can easily lead to state explosion. We can solve this by using a hook, which is a way of overwriting instructions to call our own instructions instead. Angr provides an easy way to do this via what is known as a SimProcedure, which allows you to replace a function with one that you write in Python:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
<td class="code"><pre>    <span class="k">class</span> <span class="nc">ReplacementStringsNotEqual</span><span class="p">(</span><span class="n">angr</span><span class="p">.</span><span class="n">SimProcedure</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">string_1_address</span><span class="p">,</span> <span class="n">string_2_address</span><span class="p">):</span>
            <span class="c1"># Load 100 bytes from string_1_address to string_1
</span>            <span class="n">string_1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span>
                <span class="n">string_1_address</span><span class="p">,</span>
                <span class="mi">100</span>
            <span class="p">)</span>

            <span class="c1"># Load 100 bytes from string_2_address to string_2
</span>            <span class="n">string_2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span>
                <span class="n">string_2_address</span><span class="p">,</span>
                <span class="mi">100</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">claripy</span><span class="p">.</span><span class="nc">If</span><span class="p">(</span>
                <span class="n">string_1</span> <span class="o">==</span> <span class="n">string_2</span><span class="p">,</span>
                <span class="n">claripy</span><span class="p">.</span><span class="nc">BVV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                <span class="n">claripy</span><span class="p">.</span><span class="nc">BVV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">strings_not_equal_symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">strings_not_equal</span><span class="sh">'</span>
    <span class="n">project</span><span class="p">.</span><span class="nf">hook_symbol</span><span class="p">(</span><span class="n">strings_not_equal_symbol</span><span class="p">,</span> <span class="nc">ReplacementStringsNotEqual</span><span class="p">())</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>In this code snippet, we replace all function calls to <code class="language-plaintext highlighter-rouge">'strings_not_equal'</code> to our own function defined in <code class="language-plaintext highlighter-rouge">ReplacementStringsNotEqual</code>. We can use <code class="language-plaintext highlighter-rouge">project.hook_symbol</code> because the binary includes debugging symbols, which are debugging information that was not stripped by the compiler after compilation. While it makes the binary larger, it is useful as it makes debugging with a debugger easier. However, if you encounter stripped binaries, then you would need to hook by the address of the function instead.</p>

<p>Recall that <code class="language-plaintext highlighter-rouge">strings_not_equal</code> takes in two string pointers as input, and therefore we need to load it into memory first. <code class="language-plaintext highlighter-rouge">state.memory.load(addr, size)</code> allows us to load <code class="language-plaintext highlighter-rouge">size</code> number of bytes from <code class="language-plaintext highlighter-rouge">address</code> to a variable. We can then compare the two input strings, and return 0 or 1 accordingly. We then return a concrete 32 bit integer value of either 0 or 1, depending on the results of the comparison. Note that we cannot directly return a Python integer, because Python integers do not have sizes.</p>

<p>We are now done with the basic set-up. Add the following lines to create a simulation manager, which will help to explore our states later on:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="code"><pre>    <span class="c1"># Create a simulation manager initialized with the starting state
</span>    <span class="n">simulation</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">simgr</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<h3 id="find-and-avoid">Find and Avoid</h3>
<p>Now we are faced with the question of how to tell Angr what we want it to do.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="code"><pre>    <span class="c1"># Defines when we have hit a successful state 
</span>    <span class="k">def</span> <span class="nf">is_successful</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="c1"># Dump whatever has been printed out by the binary so far into a string.
</span>        <span class="n">stdout_output</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">posix</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">b</span><span class="sh">"</span><span class="s">Phase 1 defused</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">stdout_output</span>

    <span class="n">explode_addr</span> <span class="o">=</span> <span class="mh">0x0040143a</span> <span class="c1"># explode_bomb
</span>
    <span class="n">simulation</span><span class="p">.</span><span class="nf">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">is_successful</span><span class="p">,</span> <span class="n">avoid</span><span class="o">=</span><span class="n">explode_addr</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>The above introduces a few new concepts. Let’s start from the end - <code class="language-plaintext highlighter-rouge">simulation.explore</code> tells Angr to explore states starting from our initial state, and to terminate whenever it has found something that matches the <code class="language-plaintext highlighter-rouge">find</code> condition, and also to stop exploring states that have fulfilled the <code class="language-plaintext highlighter-rouge">avoid</code> condition. Our <code class="language-plaintext highlighter-rouge">find=is_successful</code> condition is what happens when we clear the stage. We see in the disassembly of <code class="language-plaintext highlighter-rouge">main</code> that after <code class="language-plaintext highlighter-rouge">phase_defused</code> is called after <code class="language-plaintext highlighter-rouge">phase_1</code>, we call <code class="language-plaintext highlighter-rouge">puts</code> with <code class="language-plaintext highlighter-rouge">0x4023a8</code>, which corresponds to:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x4023a8</span>
<span class="mh">0x4023a8</span><span class="p">:</span>	<span class="sh">"</span><span class="s">Phase 1 defused. How about the next one?</span><span class="sh">"</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>So what <code class="language-plaintext highlighter-rouge">is_successful</code> does is that if Angr ever sees “Phase 1 defused” from stdout of the program, it will know that it has succeeded.</p>

<p>On the flipside, <code class="language-plaintext highlighter-rouge">explode_addr</code> is set to the address of <code class="language-plaintext highlighter-rouge">explode_bomb</code>, which we can see in the disassembly of Phase 1:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">disas</span> <span class="n">phase_1</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">phase_1</span><span class="p">:</span>
   <span class="mh">0x0000000000400ee0</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x0000000000400ee4</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">mov</span>    <span class="n">esi</span><span class="p">,</span><span class="mh">0x402400</span>
   <span class="mh">0x0000000000400ee9</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">call</span>   <span class="mh">0x401338</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400eee</span> <span class="o">&lt;+</span><span class="mi">14</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x0000000000400ef0</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">je</span>     <span class="mh">0x400ef7</span> <span class="o">&lt;</span><span class="n">phase_1</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ef2</span> <span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">call</span>   <span class="mh">0x40143a</span> <span class="o">&lt;</span><span class="n">explode_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000400ef7</span> <span class="o">&lt;+</span><span class="mi">23</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
   <span class="mh">0x0000000000400efb</span> <span class="o">&lt;+</span><span class="mi">27</span><span class="o">&gt;</span><span class="p">:</span>	<span class="n">ret</span>    
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>This tells Angr to avoid calling <code class="language-plaintext highlighter-rouge">explode_bomb</code> and truncate such states from its search.</p>

<p>Finally, we check if we are able to find a solution:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="code"><pre>    <span class="c1"># Check that we have found a solution
</span>    <span class="k">if</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">:</span>
        <span class="n">solution_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Case symbolic value to bytes
</span>        <span class="n">solution</span> <span class="o">=</span> <span class="n">solution_state</span><span class="p">.</span><span class="n">se</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">phase_1_input</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">Could not find the solution</span><span class="sh">'</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Here, if a solution was found, we convert our symbolic <code class="language-plaintext highlighter-rouge">phase_1_input</code> value into bytes and print it, and if not, an exception is raised.</p>

<h3 id="full-solution-script">Full Solution Script</h3>
<p>The full solution script for Phase 1 is below:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td>
<td class="code"><pre><span class="kn">import</span> <span class="n">angr</span>
<span class="kn">import</span> <span class="n">claripy</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">def</span> <span class="nf">phase_1</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="c1"># Create an Angr project.
</span>    <span class="n">path_to_binary</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># :string
</span>    <span class="n">project</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="nc">Project</span><span class="p">(</span><span class="n">path_to_binary</span><span class="p">)</span>

    <span class="c1"># Tell Angr where to start executing 
</span>    <span class="n">start_addr</span> <span class="o">=</span> <span class="mh">0x00400e3a</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">start_addr</span><span class="p">)</span>

    <span class="n">fake_addr</span> <span class="o">=</span> <span class="mh">0x40000000</span>
    <span class="n">phase_1_input</span> <span class="o">=</span> <span class="n">claripy</span><span class="p">.</span><span class="nc">BVS</span><span class="p">(</span><span class="sh">'</span><span class="s">phase_1_input</span><span class="sh">'</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">fake_addr</span><span class="p">,</span> <span class="n">phase_1_input</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">fake_addr</span>

    <span class="k">class</span> <span class="nc">ReplacementStringsNotEqual</span><span class="p">(</span><span class="n">angr</span><span class="p">.</span><span class="n">SimProcedure</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">string_1_address</span><span class="p">,</span> <span class="n">string_2_address</span><span class="p">):</span>
            <span class="c1"># Load 100 bytes from string_1_address to string_1
</span>            <span class="n">string_1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span>
                <span class="n">string_1_address</span><span class="p">,</span>
                <span class="mi">100</span>
            <span class="p">)</span>

            <span class="c1"># Load 100 bytes from string_2_address to string_2
</span>            <span class="n">string_2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span>
                <span class="n">string_2_address</span><span class="p">,</span>
                <span class="mi">100</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">claripy</span><span class="p">.</span><span class="nc">If</span><span class="p">(</span>
                <span class="n">string_1</span> <span class="o">==</span> <span class="n">string_2</span><span class="p">,</span>
                <span class="n">claripy</span><span class="p">.</span><span class="nc">BVV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                <span class="n">claripy</span><span class="p">.</span><span class="nc">BVV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">strings_not_equal_symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">strings_not_equal</span><span class="sh">'</span>
    <span class="n">project</span><span class="p">.</span><span class="nf">hook_symbol</span><span class="p">(</span><span class="n">strings_not_equal_symbol</span><span class="p">,</span> <span class="nc">ReplacementStringsNotEqual</span><span class="p">())</span>

    <span class="c1"># Create a simulation manager initialized with the starting state
</span>    <span class="n">simulation</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">simgr</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>

    <span class="c1"># Defines when we have hit a successful state 
</span>    <span class="k">def</span> <span class="nf">is_successful</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="c1"># Dump whatever has been printed out by the binary so far into a string.
</span>        <span class="n">stdout_output</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">posix</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>

        <span class="k">return</span> <span class="sa">b</span><span class="sh">"</span><span class="s">Phase 1 defused</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">stdout_output</span> <span class="c1"># :boolean
</span>
    <span class="n">explode_addr</span> <span class="o">=</span> <span class="mh">0x0040143a</span> <span class="c1"># explode_bomb
</span>
    <span class="n">simulation</span><span class="p">.</span><span class="nf">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">is_successful</span><span class="p">,</span> <span class="n">avoid</span><span class="o">=</span><span class="n">explode_addr</span><span class="p">)</span>

    <span class="c1"># Check that we have found a solution
</span>    <span class="k">if</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">:</span>
        <span class="n">solution_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Case symbolic value to bytes
</span>        <span class="n">solution</span> <span class="o">=</span> <span class="n">solution_state</span><span class="p">.</span><span class="n">se</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">phase_1_input</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">Could not find the solution</span><span class="sh">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">phase_1</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>And if we run it, we get the following output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="code"><pre><span class="err">$</span> <span class="n">python</span> <span class="n">solve</span><span class="p">.</span><span class="n">py</span> <span class="n">bomb</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">670</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">The</span> <span class="n">program</span> <span class="ow">is</span> <span class="n">accessing</span> <span class="n">memory</span> <span class="ow">or</span> <span class="n">registers</span> <span class="k">with</span> <span class="n">an</span> <span class="n">unspecified</span> <span class="n">value</span><span class="p">.</span> <span class="n">This</span> <span class="n">could</span> <span class="n">indicate</span> <span class="n">unwanted</span> <span class="n">behavior</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">670</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">angr</span> <span class="n">will</span> <span class="n">cope</span> <span class="k">with</span> <span class="n">this</span> <span class="n">by</span> <span class="n">generating</span> <span class="n">an</span> <span class="n">unconstrained</span> <span class="n">symbolic</span> <span class="n">variable</span> <span class="ow">and</span> <span class="n">continuing</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">resolve</span> <span class="n">this</span> <span class="n">by</span><span class="p">:</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">670</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="n">setting</span> <span class="n">a</span> <span class="n">value</span> <span class="n">to</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">state</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">671</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">2</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">ZERO_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY</span><span class="p">,</span><span class="n">REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">make</span> <span class="n">unknown</span> <span class="n">regions</span> <span class="n">hold</span> <span class="n">null</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">671</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">SYMBOL_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY_REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">these</span> <span class="n">messages</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">671</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">register</span> <span class="mi">20</span> <span class="k">with</span> <span class="mi">4</span> <span class="n">unconstrained</span> <span class="nb">bytes</span> <span class="n">referenced</span> <span class="k">from</span> <span class="mh">0x400eee</span> <span class="p">(</span><span class="n">phase_1</span><span class="o">+</span><span class="mh">0xe</span> <span class="ow">in</span> <span class="nf">bomb </span><span class="p">(</span><span class="mh">0x400eee</span><span class="p">))</span>
<span class="n">CRITICAL</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">752</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">sim_state</span> <span class="o">|</span> <span class="n">The</span> <span class="n">name</span> <span class="n">state</span><span class="p">.</span><span class="n">se</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="p">;</span> <span class="n">please</span> <span class="n">use</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span>
<span class="sa">b</span><span class="sh">"</span><span class="s">Border relations with Canada have never been better.</span><span class="se">\x00\x00\x00\x00</span><span class="s">Wow! You</span><span class="sh">'</span><span class="s">ve defused the secret stage!</span><span class="se">\x00</span><span class="s">flyers</span><span class="sh">"</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Because we specified 100 bytes for our symbolic input, we got 100 bytes back. Since strings are null terminated, our correct input for phase 1 is therefore “Border relations with Canada have never been better.”. We verify that it works when run with the actual binary:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="code"><pre><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">bomb</span>
<span class="n">Welcome</span> <span class="n">to</span> <span class="n">my</span> <span class="n">fiendish</span> <span class="n">little</span> <span class="n">bomb</span><span class="p">.</span> <span class="n">You</span> <span class="n">have</span> <span class="mi">6</span> <span class="n">phases</span> <span class="n">with</span>
<span class="n">which</span> <span class="n">to</span> <span class="n">blow</span> <span class="n">yourself</span> <span class="n">up</span><span class="p">.</span> <span class="n">Have</span> <span class="n">a</span> <span class="n">nice</span> <span class="n">day</span><span class="o">!</span>
<span class="n">Border</span> <span class="n">relations</span> <span class="n">with</span> <span class="n">Canada</span> <span class="n">have</span> <span class="n">never</span> <span class="n">been</span> <span class="n">better</span><span class="p">.</span>
<span class="n">Phase</span> <span class="mi">1</span> <span class="n">defused</span><span class="p">.</span> <span class="n">How</span> <span class="n">about</span> <span class="n">the</span> <span class="n">next</span> <span class="n">one</span><span class="o">?</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<p>Awesome! I hope you have enjoyed the first part of this series and that it was
helpful to you :). You can continue on to the second part <a href="/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-2/">here</a>.</p>

    </div>
  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <!-- <p class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</p> -->
    <p class="mb-2">Related Posts:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/llama-3.1-technical-report-notes/">Notes on 'The Llama 3 Herd of Models'</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/setting-up-yuancon-controller-sound-voltex/">Playing Sound Voltex at Home: Setting Up Unnamed SDVX Clone with the Yuancon SDVX Controller</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/creating-trackback-requests/">Creating Trackback Requests for Static Sites</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/high-dimensional-analysis-of-m-estimators/">A Unified Framework for High-Dimensional Analysis of M-Estimators with Decomposable Regularizers: A Guided Walkthrough</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cmu-steam-tunnels/">The CMU Steam Tunnels and Wean 9</a>
  </li>

<div id="giscus_thread" style="max-width: 800px; margin: 0 auto;">
  <script>
    let giscusTheme = localStorage.getItem("theme");
    let giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo": "fanpu/website",
        "data-repo-id": "R_kgDOIpOodA",
        "data-category": "General",
        "data-category-id": "DIC_kwDOIpOodM4CTKDC",
        "data-mapping": "title",
        "data-strict": "1",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "top",
        "data-theme": giscusTheme,
        "data-lang": "en",
        "crossorigin": "anonymous",
        "async": "",
    };


    let giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    document.getElementById("giscus_thread").appendChild(giscusScript);
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a>
</noscript>
</div>
</div>

          </div>
        </div>
        
      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024 Fan Pu  Zeng. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme.
Last updated: October 03, 2024.
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Enable Tooltips -->
  <script type="text/javascript">
  $(function () {$('[data-toggle="tooltip"]').tooltip()})
  </script>
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>
  <!-- Sidebar Table of Contents -->
  <script defer src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>


  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js"></script>
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      loader: {load: ['[tex]/mathtools']},
      tex: {
        packages: {'[+]': ['mathtools', 'ams']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          addMenu: []
        }
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
