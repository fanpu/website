<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Breaking CMU's Bomblab with Angr for Fun and Profit - Part 5 | Fan Pu Zeng</title> <meta name="author" content="Fan Pu Zeng"> <meta name="description" content="Part 5 on cracking CMU's Bomblab with Angr, where we solve Phase 5 together!"> <meta name="keywords" content="fanpu, fanpu-zeng, fzeng, zengfanpu, fan-pu, zeng-fan-pu, CMU, carnegie-mellon, machine-learning, ml, theory, courses, course-reviews, computer-science, CS, SCS"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon_new.ico%EF%B8%8F"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://fanpu.io/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-5/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Fan Pu </span>Zeng</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/courses/">cmu course reviews</a> </li> <li class="nav-item "> <a class="nav-link" href="/cmu-online/">cmu online</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div style="display:none"> $$ \DeclareMathOperator*{\argmax}{arg\,max} \DeclareMathOperator*{\argmin}{arg\,min} \newcommand{\nnz}[1]{\mbox{nnz}(#1)} \newcommand{\dotprod}[2]{\langle #1, #2 \rangle} \DeclareMathOperator*{\Pr}{\mathbf{Pr}} \DeclareMathOperator*{\E}{\mathbf{E}} \DeclareMathOperator*{\Ex}{\mathbf{E}} \DeclareMathOperator*{\Var}{\mathbf{Var}} \DeclareMathOperator*{\Cov}{\mathbf{Cov}} \DeclareMathOperator*{\stddev}{\mathbf{stddev}} \DeclareMathOperator{\littlesum} \DeclareMathOperator{\littleprod} \DeclareMathOperator*{\avg}{avg} % environments \declaretheorem[numberwithin=section]{theorem} \declaretheorem[sibling=theorem]{lemma} \declaretheorem[sibling=theorem]{claim} \declaretheorem[sibling=theorem]{proposition} \declaretheorem[sibling=theorem]{fact} \declaretheorem[sibling=theorem]{corollary} \declaretheorem[sibling=theorem]{conjecture} \declaretheorem[sibling=theorem]{question} \declaretheorem[sibling=theorem]{answer} \declaretheorem[sibling=theorem]{solution} \declaretheorem[sibling=theorem]{hypothesis} \declaretheorem[sibling=theorem]{exercise} \theoremstyle{definition} \declaretheorem[sibling=theorem]{definition} \declaretheorem[sibling=theorem]{remark} \declaretheorem[sibling=theorem]{notation} \declaretheorem[sibling=theorem]{observation} \declaretheorem[sibling=theorem]{example} \newcommand{\ignore}[1]{} % probability type operators \let\Pr\relax \DeclareMathOperator*{\Pr}{\mathbf{Pr}} \DeclareMathOperator*{\E}{\mathbf{E}} \DeclareMathOperator*{\Ex}{\mathbf{E}} \DeclareMathOperator*{\Var}{\mathbf{Var}} \DeclareMathOperator*{\Cov}{\mathbf{Cov}} \DeclareMathOperator*{\stddev}{\mathbf{stddev}} \DeclareMathOperator{\littlesum} \DeclareMathOperator{\littleprod} \DeclareMathOperator*{\avg}{avg} % math terms \DeclareMathOperator{\poly}{poly} \DeclareMathOperator{\polylog}{polylog} \DeclareMathOperator{\size}{size} \DeclareMathOperator{\sgn}{sgn} \DeclareMathOperator{\dist}{dist} \DeclareMathOperator{\vol}{vol} \DeclareMathOperator{\spn}{span} \DeclareMathOperator{\supp}{supp} \DeclareMathOperator{\tr}{tr} \DeclareMathOperator{\Tr}{Tr} \DeclareMathOperator{\codim}{codim} \DeclareMathOperator{\diag}{diag} % number systems \newcommand{\R}{\mathbb R} \newcommand{\C}{\mathbb C} \newcommand{\N}{\mathbb N} \newcommand{\Z}{\mathbb Z} \newcommand{\F}{\mathbb F} \newcommand{\Q}{\mathbb Q} % complexity classes \newcommand{\PTIME}{\mathsf{P}} \newcommand{\LOGSPACE}{\mathsf{L}} \newcommand{\ZPP}{\mathsf{ZPP}} \newcommand{\RP}{\mathsf{RP}} \newcommand{\BPP}{\mathsf{BPP}} \newcommand{\P}{\mathsf{P}} \newcommand{\NP}{\mathsf{NP}} \newcommand{\TC}{\mathsf{TC}} \newcommand{\AC}{\mathsf{AC}} \newcommand{\SC}{\mathsf{SC}} \newcommand{\SZK}{\mathsf{SZK}} \newcommand{\AM}{\mathsf{AM}} \newcommand{\IP}{\mathsf{IP}} \newcommand{\PSPACE}{\mathsf{PSPACE}} \newcommand{\EXP}{\mathsf{EXP}} \newcommand{\MIP}{\mathsf{MIP}} \newcommand{\NEXP}{\mathsf{NEXP}} \newcommand{\BQP}{\mathsf{BQP}} \newcommand{\distP}{\mathsf{dist\textbf{P}}} \newcommand{\distNP}{\mathsf{dist\textbf{NP}}} % short forms \newcommand{\eps}{\epsilon} \newcommand{\lam}{\lambda} \newcommand{\dleta}{\delta} \newcommand{\simga}{\sigma} \newcommand{\vphi}{\varphi} \newcommand{\la}{\langle} \newcommand{\ra}{\rangle} \newcommand{\wt}[1]{\widetilde{#1}} \newcommand{\wh}[1]{\widehat{#1}} \newcommand{\ol}[1]{\overline{#1}} \newcommand{\ul}[1]{\underline{#1}} \newcommand{\ot}{\otimes} \newcommand{\zo}{\{0,1\}} \newcommand{\co}{:} %\newcommand{\co}{\colon} \newcommand{\bdry}{\partial} \newcommand{\grad}{\nabla} \newcommand{\transp}{^\intercal} \newcommand{\inv}{^{-1}} \newcommand{\symmdiff}{\triangle} \newcommand{\symdiff}{\symmdiff} \newcommand{\half}{\tfrac{1}{2}} \newcommand{\bbone}{\mathbbm 1} \newcommand{\Id}{\bbone} \newcommand{\SAT}{\mathsf{SAT}} % calligraphic letters \newcommand{\calA}{\mathcal{A}} \newcommand{\calB}{\mathcal{B}} \newcommand{\calC}{\mathcal{C}} \newcommand{\calD}{\mathcal{D}} \newcommand{\calE}{\mathcal{E}} \newcommand{\calF}{\mathcal{F}} \newcommand{\calG}{\mathcal{G}} \newcommand{\calH}{\mathcal{H}} \newcommand{\calI}{\mathcal{I}} \newcommand{\calJ}{\mathcal{J}} \newcommand{\calK}{\mathcal{K}} \newcommand{\calL}{\mathcal{L}} \newcommand{\calM}{\mathcal{M}} \newcommand{\calN}{\mathcal{N}} \newcommand{\calO}{\mathcal{O}} \newcommand{\calP}{\mathcal{P}} \newcommand{\calQ}{\mathcal{Q}} \newcommand{\calR}{\mathcal{R}} \newcommand{\calS}{\mathcal{S}} \newcommand{\calT}{\mathcal{T}} \newcommand{\calU}{\mathcal{U}} \newcommand{\calV}{\mathcal{V}} \newcommand{\calW}{\mathcal{W}} \newcommand{\calX}{\mathcal{X}} \newcommand{\calY}{\mathcal{Y}} \newcommand{\calZ}{\mathcal{Z}} % bold \newcommand{\bone}{\boldsymbol{1}} \newcommand{\bbeta}{\boldsymbol{\beta}} \newcommand{\bdelta}{\boldsymbol{\delta}} \newcommand{\bepsilon}{\boldsymbol{\epsilon}} \newcommand{\blambda}{\boldsymbol{\lambda}} \newcommand{\bomega}{\boldsymbol{\omega}} \newcommand{\bpi}{\boldsymbol{\pi}} \newcommand{\bphi}{\boldsymbol{\phi}} \newcommand{\bvphi}{\boldsymbol{\varphi}} \newcommand{\bpsi}{\boldsymbol{\psi}} \newcommand{\bsigma}{\boldsymbol{\sigma}} \newcommand{\btheta}{\boldsymbol{\theta}} \newcommand{\btau}{\boldsymbol{\tau}} \newcommand{\ba}{\boldsymbol{a}} \newcommand{\bb}{\boldsymbol{b}} \newcommand{\bc}{\boldsymbol{c}} \newcommand{\bd}{\boldsymbol{d}} \newcommand{\be}{\boldsymbol{e}} \newcommand{\boldf}{\boldsymbol{f}} \newcommand{\bg}{\boldsymbol{g}} \newcommand{\bh}{\boldsymbol{h}} \newcommand{\bi}{\boldsymbol{i}} \newcommand{\bj}{\boldsymbol{j}} \newcommand{\bk}{\boldsymbol{k}} \newcommand{\bell}{\boldsymbol{\ell}} \newcommand{\bm}{\boldsymbol{m}} \newcommand{\bn}{\boldsymbol{n}} \newcommand{\bo}{\boldsymbol{o}} \newcommand{\bp}{\boldsymbol{p}} \newcommand{\bq}{\boldsymbol{q}} \newcommand{\br}{\boldsymbol{r}} \newcommand{\bs}{\boldsymbol{s}} \newcommand{\bt}{\boldsymbol{t}} \newcommand{\bu}{\boldsymbol{u}} \newcommand{\bv}{\boldsymbol{v}} \newcommand{\bw}{\boldsymbol{w}} \newcommand{\bx}{\boldsymbol{x}} \newcommand{\by}{\boldsymbol{y}} \newcommand{\bz}{\boldsymbol{z}} \newcommand{\bA}{\boldsymbol{A}} \newcommand{\bB}{\boldsymbol{B}} \newcommand{\bC}{\boldsymbol{C}} \newcommand{\bD}{\boldsymbol{D}} \newcommand{\bE}{\boldsymbol{E}} \newcommand{\bF}{\boldsymbol{F}} \newcommand{\bG}{\boldsymbol{G}} \newcommand{\bH}{\boldsymbol{H}} \newcommand{\bI}{\boldsymbol{I}} \newcommand{\bJ}{\boldsymbol{J}} \newcommand{\bK}{\boldsymbol{K}} \newcommand{\bL}{\boldsymbol{L}} \newcommand{\bM}{\boldsymbol{M}} \newcommand{\bN}{\boldsymbol{N}} \newcommand{\bP}{\boldsymbol{P}} \newcommand{\bQ}{\boldsymbol{Q}} \newcommand{\bR}{\boldsymbol{R}} \newcommand{\bS}{\boldsymbol{S}} \newcommand{\bT}{\boldsymbol{T}} \newcommand{\bU}{\boldsymbol{U}} \newcommand{\bV}{\boldsymbol{V}} \newcommand{\bW}{\boldsymbol{W}} \newcommand{\bX}{\boldsymbol{X}} \newcommand{\bY}{\boldsymbol{Y}} \newcommand{\bZ}{\boldsymbol{Z}} % others \newcommand{\false}} \newcommand{\true}} % bold calligraphic \newcommand{\bcalG}{\boldsymbol{\calG}} \newcommand{\calbG}{\bcalG} \newcommand{\bcalX}{\boldsymbol{\calX}} \newcommand{\calbX}{\bcalX} \newcommand{\bcalY}{\boldsymbol{\calY}} \newcommand{\calbY}{\bcalY} \newcommand{\bcalZ}{\boldsymbol{\calZ}} \newcommand{\calbZ}{\bcalZ} % left-right wrappers \DeclarePairedDelimiter\parens{\lparen}{\rparen} \DeclarePairedDelimiter\abs{\lvert}{\rvert} \DeclarePairedDelimiter\norm{\lVert}{\rVert} \DeclarePairedDelimiter\floor{\lfloor}{\rfloor} \DeclarePairedDelimiter\ceil{\lceil}{\rceil} \DeclarePairedDelimiter\braces{\lbrace}{\rbrace} \DeclarePairedDelimiter\bracks{\lbrack}{\rbrack} \DeclarePairedDelimiter\angles{\langle}{\rangle} % something for figures \newcommand{\myfig}[4]{\begin{figure}[H] \centering \includegraphics[width=#1\textwidth]{#2} \caption{#3} \label{#4} \end{figure}} \definecolor{codegreen}{rgb}{0,0.6,0} \definecolor{codegray}{rgb}{0.5,0.5,0.5} \definecolor{codepurple}{rgb}{0.58,0,0.82} \definecolor{backcolour}{rgb}{0.95,0.95,0.92} \lstdefinestyle{mystyle}{ backgroundcolor=\color{backcolour}, commentstyle=\color{codegreen}, keywordstyle=\color{magenta}, numberstyle=\tiny\color{codegray}, stringstyle=\color{codepurple}, basicstyle=\ttfamily\footnotesize, breakatwhitespace=false, breaklines=true, captionpos=b, keepspaces=true, numbers=left, numbersep=5pt, showspaces=false, showstringspaces=false, showtabs=false, tabsize=2 } \lstset{style=mystyle} $$ </div> <div class="post"> <header class="post-header"> <h1 class="post-title">Breaking CMU's Bomblab with Angr for Fun and Profit - Part 5</h1> <p class="post-meta">August 2, 2020• fanpu</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/rev"> <i class="fas fa-hashtag fa-sm"></i> rev</a>   <a href="/blog/tag/ctf"> <i class="fas fa-hashtag fa-sm"></i> ctf</a>   <a href="/blog/tag/code"> <i class="fas fa-hashtag fa-sm"></i> code</a>   </p> </header> <figure> <picture> <img src="/assets/img/posts/niagara_falls.jpg" class="preview z-depth-1 rounded center" width="100%" height="450px" alt="post.cover" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> Niagara Falls, New York, USA </div> <article class="post-content"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h3"><a href="#phase-5">Phase 5</a></li> <li class="toc-entry toc-h3"><a href="#almost-there">Almost There?</a></li> <li class="toc-entry toc-h3"><a href="#adding-constraints">Adding Constraints</a></li> </ul> <p>This is Part 5 on cracking CMU’s Bomblab with Angr. If you just stumbled upon this, I would recommend starting with part 1 <a href="/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-1/">here</a>.</p> <h3 id="phase-5"> <a class="anchor" href="#phase-5" aria-hidden="true"><span class="octicon octicon-link"></span></a>Phase 5</h3> <p>Let’s disassemble Phase 5:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td> <td class="code"><pre><span class="n">gef</span><span class="err">➤</span>  <span class="n">disas</span> <span class="n">phase_5</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">phase_5</span><span class="o">:</span>
   <span class="mh">0x0000000000401062</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">rbx</span>
   <span class="mh">0x0000000000401063</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x20</span>
   <span class="mh">0x0000000000401067</span> <span class="o">&lt;+</span><span class="mi">5</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">rdi</span>
   <span class="mh">0x000000000040106a</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">fs</span><span class="o">:</span><span class="mh">0x28</span>
   <span class="mh">0x0000000000401073</span> <span class="o">&lt;+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="n">rax</span>
   <span class="mh">0x0000000000401078</span> <span class="o">&lt;+</span><span class="mi">22</span><span class="o">&gt;:</span>	<span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x000000000040107a</span> <span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40131b</span> <span class="o">&lt;</span><span class="n">string_length</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040107f</span> <span class="o">&lt;+</span><span class="mi">29</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x6</span>
   <span class="mh">0x0000000000401082</span> <span class="o">&lt;+</span><span class="mi">32</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x4010d2</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">112</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401084</span> <span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40143a</span> <span class="o">&lt;</span><span class="n">explode_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x0000000000401089</span> <span class="o">&lt;+</span><span class="mi">39</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x4010d2</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">112</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040108b</span> <span class="o">&lt;+</span><span class="mi">41</span><span class="o">&gt;:</span>	<span class="n">movzx</span>  <span class="n">ecx</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="p">]</span>
   <span class="mh">0x000000000040108f</span> <span class="o">&lt;+</span><span class="mi">45</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="p">],</span><span class="n">cl</span>
   <span class="mh">0x0000000000401092</span> <span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rdx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="p">]</span>
   <span class="mh">0x0000000000401096</span> <span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0xf</span>
   <span class="mh">0x0000000000401099</span> <span class="o">&lt;+</span><span class="mi">55</span><span class="o">&gt;:</span>	<span class="n">movzx</span>  <span class="n">edx</span><span class="p">,</span><span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rdx</span><span class="o">+</span><span class="mh">0x4024b0</span><span class="p">]</span>
   <span class="mh">0x00000000004010a0</span> <span class="o">&lt;+</span><span class="mi">62</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x10</span><span class="p">],</span><span class="n">dl</span>
   <span class="mh">0x00000000004010a4</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x1</span>
   <span class="mh">0x00000000004010a8</span> <span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x6</span>
   <span class="mh">0x00000000004010ac</span> <span class="o">&lt;+</span><span class="mi">74</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x40108b</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010ae</span> <span class="o">&lt;+</span><span class="mi">76</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x16</span><span class="p">],</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004010b3</span> <span class="o">&lt;+</span><span class="mi">81</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">esi</span><span class="p">,</span><span class="mh">0x40245e</span>
   <span class="mh">0x00000000004010b8</span> <span class="o">&lt;+</span><span class="mi">86</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">rdi</span><span class="p">,[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
   <span class="mh">0x00000000004010bd</span> <span class="o">&lt;+</span><span class="mi">91</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x401338</span> <span class="o">&lt;</span><span class="n">strings_not_equal</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010c2</span> <span class="o">&lt;+</span><span class="mi">96</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x00000000004010c4</span> <span class="o">&lt;+</span><span class="mi">98</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x4010d9</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">119</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010c6</span> <span class="o">&lt;+</span><span class="mi">100</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x40143a</span> <span class="o">&lt;</span><span class="n">explode_bomb</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010cb</span> <span class="o">&lt;+</span><span class="mi">105</span><span class="o">&gt;:</span>	<span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
   <span class="mh">0x00000000004010d0</span> <span class="o">&lt;+</span><span class="mi">110</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x4010d9</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">119</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010d2</span> <span class="o">&lt;+</span><span class="mi">112</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004010d7</span> <span class="o">&lt;+</span><span class="mi">117</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x40108b</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010d9</span> <span class="o">&lt;+</span><span class="mi">119</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>
   <span class="mh">0x00000000004010de</span> <span class="o">&lt;+</span><span class="mi">124</span><span class="o">&gt;:</span>	<span class="n">xor</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">fs</span><span class="o">:</span><span class="mh">0x28</span>
   <span class="mh">0x00000000004010e7</span> <span class="o">&lt;+</span><span class="mi">133</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x4010ee</span> <span class="o">&lt;</span><span class="n">phase_5</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010e9</span> <span class="o">&lt;+</span><span class="mi">135</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x400b30</span> <span class="o">&lt;</span><span class="n">__stack_chk_fail</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004010ee</span> <span class="o">&lt;+</span><span class="mi">140</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x20</span>
   <span class="mh">0x00000000004010f2</span> <span class="o">&lt;+</span><span class="mi">144</span><span class="o">&gt;:</span>	<span class="n">pop</span>    <span class="n">rbx</span>
   <span class="mh">0x00000000004010f3</span> <span class="o">&lt;+</span><span class="mi">145</span><span class="o">&gt;:</span>	<span class="n">ret</span>    
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>We see <code class="language-plaintext highlighter-rouge">strings_not_equal</code>, like in Phase 1, and also <code class="language-plaintext highlighter-rouge">string_length</code>. Also, right after the <code class="language-plaintext highlighter-rouge">string_length</code> call there is a comparison with 6, so we can assume that it wants 6 bytes of input. Let’s craft the input again in the same stack frame as the function by setting <code class="language-plaintext highlighter-rouge">rdi</code> to our symbolic bitvector of 6 bytes:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> <td class="code"><pre><span class="k">def</span> <span class="nf">phase_5</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="c1"># Create an Angr project.
</span>    <span class="n">path_to_binary</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># :string
</span>    <span class="n">project</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="n">Project</span><span class="p">(</span><span class="n">path_to_binary</span><span class="p">)</span>

    <span class="c1"># Tell Angr where to start executing 
</span>    <span class="n">start_addr</span> <span class="o">=</span> <span class="mh">0x00401062</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">start_addr</span><span class="p">)</span>

    <span class="n">fake_addr</span> <span class="o">=</span> <span class="mh">0x40000000</span>
    <span class="n">input_len</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">phase_5_input</span> <span class="o">=</span> <span class="n">claripy</span><span class="p">.</span><span class="n">BVS</span><span class="p">(</span><span class="s">'phase_5_input'</span><span class="p">,</span> <span class="n">input_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">fake_addr</span><span class="p">,</span> <span class="n">phase_5_input</span><span class="p">)</span>
    <span class="n">initial_state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">fake_addr</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Recall how we had to replace <code class="language-plaintext highlighter-rouge">strings_not_equal</code> with our own custom implementation back in Phase 1 to avoid state explosion? I recently found out that there was a really simple way of doing this by using the built-in libc ones that Angr already helpfully provides. For instance, <code class="language-plaintext highlighter-rouge">strings_not_equal</code> can simply be replaced with the libc <code class="language-plaintext highlighter-rouge">strcmp</code>, whose definition can be found <a href="https://github.com/angr/angr/blob/master/angr/procedures/libc/strcmp.py" rel="external nofollow noopener" target="_blank">here</a>. Similarly, <code class="language-plaintext highlighter-rouge">string_length</code> is the same as the libc <code class="language-plaintext highlighter-rouge">strlen</code>, which can be found <a href="https://github.com/angr/angr/blob/master/angr/procedures/libc/strlen.py" rel="external nofollow noopener" target="_blank">here</a>. So let us replace those using this method, to avoid state explosion:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td> <td class="code"><pre>    <span class="n">strcmp</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="n">SIM_PROCEDURES</span><span class="p">[</span><span class="s">'libc'</span><span class="p">][</span><span class="s">'strcmp'</span><span class="p">]</span>
    <span class="n">strlen</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="n">SIM_PROCEDURES</span><span class="p">[</span><span class="s">'libc'</span><span class="p">][</span><span class="s">'strlen'</span><span class="p">]</span>

    <span class="n">strings_not_equal_symbol</span> <span class="o">=</span> <span class="s">'strings_not_equal'</span>
    <span class="n">string_length_symbol</span> <span class="o">=</span> <span class="s">"string_length"</span>

    <span class="n">project</span><span class="p">.</span><span class="n">hook_symbol</span><span class="p">(</span><span class="n">strings_not_equal_symbol</span><span class="p">,</span> <span class="n">strcmp</span><span class="p">())</span>
    <span class="n">project</span><span class="p">.</span><span class="n">hook_symbol</span><span class="p">(</span><span class="n">string_length_symbol</span><span class="p">,</span> <span class="n">strlen</span><span class="p">())</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Finally, we set our success address to be at the <code class="language-plaintext highlighter-rouge">ret</code> statement, and the same avoid address as before:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> <td class="code"><pre>    <span class="c1"># Create a simulation manager initialized with the starting state
</span>    <span class="n">simulation</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">simgr</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>

    <span class="n">success_addr</span> <span class="o">=</span> <span class="mh">0x004010f3</span> <span class="c1"># right before ret
</span>    <span class="n">explode_addr</span> <span class="o">=</span> <span class="mh">0x0040143a</span> <span class="c1"># explode_bomb
</span>
    <span class="n">simulation</span><span class="p">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">success_addr</span><span class="p">,</span> <span class="n">avoid</span><span class="o">=</span><span class="n">explode_addr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">:</span>
        <span class="n">solution_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="p">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Case symbolic value to bytes
</span>        <span class="n">solution</span> <span class="o">=</span> <span class="n">solution_state</span><span class="p">.</span><span class="n">se</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="n">phase_5_input</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Could not find the solution'</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h3 id="almost-there"> <a class="anchor" href="#almost-there" aria-hidden="true"><span class="octicon octicon-link"></span></a>Almost There?</h3> <p>Let’s try running it!</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="err">$</span> <span class="n">python</span> <span class="n">solve</span><span class="p">.</span><span class="n">py</span> <span class="n">bomb</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">The</span> <span class="n">program</span> <span class="n">is</span> <span class="n">accessing</span> <span class="n">memory</span> <span class="n">or</span> <span class="n">registers</span> <span class="n">with</span> <span class="n">an</span> <span class="n">unspecified</span> <span class="n">value</span><span class="p">.</span> <span class="n">This</span> <span class="n">could</span> <span class="n">indicate</span> <span class="n">unwanted</span> <span class="n">behavior</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">angr</span> <span class="n">will</span> <span class="n">cope</span> <span class="n">with</span> <span class="n">this</span> <span class="n">by</span> <span class="n">generating</span> <span class="n">an</span> <span class="n">unconstrained</span> <span class="n">symbolic</span> <span class="n">variable</span> <span class="n">and</span> <span class="n">continuing</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">resolve</span> <span class="n">this</span> <span class="n">by</span><span class="o">:</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="n">setting</span> <span class="n">a</span> <span class="n">value</span> <span class="n">to</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">state</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">2</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">ZERO_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY</span><span class="p">,</span><span class="n">REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">make</span> <span class="n">unknown</span> <span class="n">regions</span> <span class="n">hold</span> <span class="n">null</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">SYMBOL_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY_REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">these</span> <span class="n">messages</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">569</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="k">register</span> <span class="n">rbx</span> <span class="n">with</span> <span class="mi">8</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401062</span> <span class="p">(</span><span class="n">phase_5</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401062</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">579</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x40000006</span> <span class="n">with</span> <span class="mi">250</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x40131b</span> <span class="p">(</span><span class="n">string_length</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x40131b</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="mi">694</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffeffd1</span> <span class="n">with</span> <span class="mi">7</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401092</span> <span class="p">(</span><span class="n">phase_5</span><span class="o">+</span><span class="mh">0x30</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401092</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">23</span><span class="p">,</span><span class="mi">609</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffefff8</span> <span class="n">with</span> <span class="mi">232</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401338</span> <span class="p">(</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401338</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">23</span><span class="p">,</span><span class="mi">610</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffeffe7</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401338</span> <span class="p">(</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401338</span><span class="p">))</span>
<span class="n">CRITICAL</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">220</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">sim_state</span> <span class="o">|</span> <span class="n">The</span> <span class="n">name</span> <span class="n">state</span><span class="p">.</span><span class="n">se</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">;</span> <span class="n">please</span> <span class="n">use</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span>
<span class="n">b</span><span class="err">'\</span><span class="n">t</span><span class="err">\</span><span class="n">x0f</span><span class="err">\</span><span class="n">x0e</span><span class="err">\</span><span class="n">x05</span><span class="err">\</span><span class="n">x06</span><span class="err">\</span><span class="n">x07</span><span class="err">'</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>We indeed got a solution, but those are not ASCII printable characters! Of course, we can pipe the input to the binary with something like pwntools, but this seems to not be the point of the assignment. This is where we introduce the new concept of adding constraints to our input.</p> <h3 id="adding-constraints"> <a class="anchor" href="#adding-constraints" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding Constraints</h3> <p>We want to constrain our input bytes such that they are in the printable range. For simplicity, I will restrict it further to be smallest range that include the alphanumeric range, which includes a few non-alphanumeric characters as well. This will range from ‘0’ (0x30) to ‘z’ (0x7A), which you can quickly verify by pulling up an ASCII table with <code class="language-plaintext highlighter-rouge">man ascii</code>.</p> <p>We’ll add these constraints right before we build the simulation:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="code"><pre>    <span class="k">def</span> <span class="nf">constrain_printable</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">claripy</span><span class="p">.</span><span class="n">And</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'0'</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="p">,</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'z'</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_len</span><span class="p">):</span>
        <span class="n">initial_state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">constrain_printable</span><span class="p">(</span><span class="n">phase_5_input</span><span class="p">.</span><span class="n">get_byte</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Now, we will either get a solution that is printable, or perhaps no solution at all. Let’s try:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="err">$</span> <span class="n">python</span> <span class="n">solve</span><span class="p">.</span><span class="n">py</span> <span class="n">bomb</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">The</span> <span class="n">program</span> <span class="n">is</span> <span class="n">accessing</span> <span class="n">memory</span> <span class="n">or</span> <span class="n">registers</span> <span class="n">with</span> <span class="n">an</span> <span class="n">unspecified</span> <span class="n">value</span><span class="p">.</span> <span class="n">This</span> <span class="n">could</span> <span class="n">indicate</span> <span class="n">unwanted</span> <span class="n">behavior</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">angr</span> <span class="n">will</span> <span class="n">cope</span> <span class="n">with</span> <span class="n">this</span> <span class="n">by</span> <span class="n">generating</span> <span class="n">an</span> <span class="n">unconstrained</span> <span class="n">symbolic</span> <span class="n">variable</span> <span class="n">and</span> <span class="n">continuing</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">resolve</span> <span class="n">this</span> <span class="n">by</span><span class="o">:</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="n">setting</span> <span class="n">a</span> <span class="n">value</span> <span class="n">to</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">state</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">2</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">ZERO_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY</span><span class="p">,</span><span class="n">REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">make</span> <span class="n">unknown</span> <span class="n">regions</span> <span class="n">hold</span> <span class="n">null</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">state</span> <span class="n">option</span> <span class="n">SYMBOL_FILL_UNCONSTRAINED_</span><span class="p">{</span><span class="n">MEMORY_REGISTERS</span><span class="p">},</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">these</span> <span class="n">messages</span><span class="p">.</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">766</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="k">register</span> <span class="n">rbx</span> <span class="n">with</span> <span class="mi">8</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401062</span> <span class="p">(</span><span class="n">phase_5</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401062</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">796</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x40000006</span> <span class="n">with</span> <span class="mi">250</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x40131b</span> <span class="p">(</span><span class="n">string_length</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x40131b</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">906</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffeffd1</span> <span class="n">with</span> <span class="mi">7</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401092</span> <span class="p">(</span><span class="n">phase_5</span><span class="o">+</span><span class="mh">0x30</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401092</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">45</span><span class="p">,</span><span class="mi">753</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffefff8</span> <span class="n">with</span> <span class="mi">232</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401338</span> <span class="p">(</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401338</span><span class="p">))</span>
<span class="n">WARNING</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">45</span><span class="p">,</span><span class="mi">753</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">state_plugins</span><span class="p">.</span><span class="n">symbolic_memory</span> <span class="o">|</span> <span class="n">Filling</span> <span class="n">memory</span> <span class="n">at</span> <span class="mh">0x7fffffffffeffe7</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">unconstrained</span> <span class="n">bytes</span> <span class="n">referenced</span> <span class="n">from</span> <span class="mh">0x401338</span> <span class="p">(</span><span class="n">strings_not_equal</span><span class="o">+</span><span class="mh">0x0</span> <span class="n">in</span> <span class="n">bomb</span> <span class="p">(</span><span class="mh">0x401338</span><span class="p">))</span>
<span class="n">CRITICAL</span> <span class="o">|</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">20</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">356</span> <span class="o">|</span> <span class="n">angr</span><span class="p">.</span><span class="n">sim_state</span> <span class="o">|</span> <span class="n">The</span> <span class="n">name</span> <span class="n">state</span><span class="p">.</span><span class="n">se</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">;</span> <span class="n">please</span> <span class="n">use</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span>
<span class="n">b</span><span class="err">'</span><span class="mi">9</span><span class="o">?&gt;</span><span class="mi">567</span><span class="err">'</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Fantastic! Let’s try this input on the bomb:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">bomb</span>
<span class="n">Welcome</span> <span class="n">to</span> <span class="n">my</span> <span class="n">fiendish</span> <span class="n">little</span> <span class="n">bomb</span><span class="p">.</span> <span class="n">You</span> <span class="n">have</span> <span class="mi">6</span> <span class="n">phases</span> <span class="n">with</span>
<span class="n">which</span> <span class="n">to</span> <span class="n">blow</span> <span class="n">yourself</span> <span class="n">up</span><span class="p">.</span> <span class="n">Have</span> <span class="n">a</span> <span class="n">nice</span> <span class="n">day</span><span class="o">!</span>
<span class="n">Border</span> <span class="n">relations</span> <span class="n">with</span> <span class="n">Canada</span> <span class="n">have</span> <span class="n">never</span> <span class="n">been</span> <span class="n">better</span><span class="p">.</span>
<span class="n">Phase</span> <span class="mi">1</span> <span class="n">defused</span><span class="p">.</span> <span class="n">How</span> <span class="n">about</span> <span class="n">the</span> <span class="n">next</span> <span class="n">one</span><span class="o">?</span>
<span class="mi">1</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">8</span> <span class="mi">16</span> <span class="mi">32</span>
<span class="n">That</span><span class="err">'</span><span class="n">s</span> <span class="n">number</span> <span class="mi">2</span><span class="p">.</span>  <span class="n">Keep</span> <span class="n">going</span><span class="o">!</span>
<span class="mi">1</span> <span class="mi">311</span>
<span class="n">Halfway</span> <span class="n">there</span><span class="o">!</span>
<span class="mi">7</span> <span class="mi">0</span>
<span class="n">So</span> <span class="n">you</span> <span class="n">got</span> <span class="n">that</span> <span class="n">one</span><span class="p">.</span>  <span class="n">Try</span> <span class="n">this</span> <span class="n">one</span><span class="p">.</span>
<span class="mi">9</span><span class="o">?&gt;</span><span class="mi">567</span>
<span class="n">Good</span> <span class="n">work</span><span class="o">!</span>  <span class="n">On</span> <span class="n">to</span> <span class="n">the</span> <span class="n">next</span><span class="p">...</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Looks like it worked! Thanks for reading so far, and I hope you enjoyed it! You can continue on to Part 6 <a href="/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-6/">here</a>.</p> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"fanpu/website","data-repo-id":"R_kgDOIpOodA","data-category":"General","data-category-id":"DIC_kwDOIpOodM4CTKDC","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Fan Pu Zeng. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$('[data-toggle="tooltip"]').tooltip()});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={loader:{load:["[tex]/mathtools"]},tex:{packages:{"[+]":["mathtools","ams"]}},options:{renderActions:{addMenu:[]}}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S3VHEYH05S"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S3VHEYH05S");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script> <script>anchors.add("h1, h2, h3");</script> </body> </html>